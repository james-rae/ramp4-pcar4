import { bd as e$2, be as y$1, bf as a$3, a1 as d$3, e6 as S, N as has, ed as o$8, bl as d$4, bA as f$2, aC as l$9, bc as e$3, aD as u$8, s as s$4, G as n$5, kd as h, dN as s$5, V as L$1, e_ as p$4, dd as o$a, ir as s$6, oA as i$4, aB as e$4, oB as m$5, db as u$9, fz as n$6, el as S$1, ek as y$2, ei as d$5, oC as f$3, oD as a$6, is as a$7, P as a$8, fk as g, fT as d$6, lK as t$8, oE as F$1, oF as w$1, bj as d$7, gX as A$1, bg as v, bi as I$1, l6 as x$2, fo as b$1, oG as o$d, da as i$7, oH as J, oI as v$1, oJ as M$2, oK as L$2, oL as O$1, kt as b$2, oM as w$2, oN as je, mg as u$a, fy as d$8, X as O$2, fu as f$5, hT as n$9, a0 as V, O as O$3, aQ as e$6, a_ as w$3, bk as P$1, bp as u$b, ds as tt, oO as u$c, ax as b$3, oP as T } from './main-CGBWc59Z.js';
import { b as h$1, E as E$1, R as R$1, a as a$4, N, c as s$7 } from './Container-C6eOHu3y.js';
import { i as i$9 } from './timeSupport-mRAhXLI9.js';
import { t as t$a } from './highlightReasons-CMNvxoUc.js';
import { f as f$4, y as y$3 } from './LayerView-DUMH7O5f.js';
import { i as i$3, r as r$5, a as r$6 } from './TechniqueInstance-B7SszBst.js';
import { t as t$5 } from './CircularArray-BCXLb8ry.js';
import { b } from './WGLContainer-DmNNClwO.js';
import { o as o$9 } from './tileUtils-Ceq3VL9e.js';
import { b as ee$1, r as o$b, v as me, x as re$1 } from './UpdateTracking2D-tfVHyc-s.js';
import { i as i$6, o as o$c } from './enums-CHdyfzUK.js';
import { l as l$a } from './SDFHelper-BLpz8wm6.js';
import './LabelMetric-DeEwVo6w.js';
import { G } from './definitions-BdwlvHBE.js';
import { n as n$7, h as h$2, M as M$1, e as t$6, f as h$3, g as a$5, i as i$5, x as x$1, d as t$7, m as m$6, j as c$7, c as t$9 } from './FeatureCommandQueue-BfkJGkV1.js';
import { e as e$5 } from './HighlightCounter-DOjPv-Sy.js';
import { p as p$5, n as n$8 } from './popupUtils-5nWm5qmp.js';
import { i as i$8 } from './RefreshableLayerView-DjYf5VMN.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let p$3=class p extends d$3{constructor(){super(...arguments),this.isAggregate=!0;}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer?.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};e$2([y$1({type:Boolean})],p$3.prototype,"isAggregate",void 0),p$3=e$2([a$3("esri.AggregateGraphic")],p$3);const s$3=p$3;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let c$6=class c extends S{constructor(e){super(e),this._filter=null,this.duration=has("mapview-transitions-duration"),this._excludedEffectView=new h$1(e),this._includedEffectView=new h$1(e);}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e);}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e;}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t);}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null;}_transitionTo(e){const t=this._get("featureEffect"),i=e,s=i?.includedEffect,f=i?.excludedEffect,c=this._includedEffectView.canTransitionTo(s)&&this._excludedEffectView.canTransitionTo(f);this._includedEffectView.effect=s,this._excludedEffectView.effect=f,this._set("featureEffect",i),this._filter=i?.filter||t?.filter||null,c||this.endTransitions();}};e$2([y$1()],c$6.prototype,"_filter",void 0),e$2([y$1()],c$6.prototype,"_excludedEffectView",void 0),e$2([y$1()],c$6.prototype,"_includedEffectView",void 0),e$2([y$1()],c$6.prototype,"duration",void 0),e$2([y$1()],c$6.prototype,"excludedEffects",null),e$2([y$1()],c$6.prototype,"featureEffect",null),e$2([y$1()],c$6.prototype,"filter",null),e$2([y$1()],c$6.prototype,"hasEffects",null),e$2([y$1()],c$6.prototype,"includedEffects",null),e$2([y$1({value:0})],c$6.prototype,"scale",null),e$2([y$1()],c$6.prototype,"transitioning",null),c$6=e$2([a$3("esri.layers.effects.FeatureEffectView")],c$6);const r$4=c$6;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let c$5=class c extends d$4{constructor(){super(...arguments),this.features=[];}readFeatures(e,t){const o=f$2.fromJSON(t.spatialReference),s=[];for(let a=0;a<e.length;a++){const t=e[a],p=s$3.fromJSON(t),c=t.geometry?.spatialReference;null==p.geometry||c||(p.geometry.spatialReference=o);const m=t.aggregateGeometries,i=p.aggregateGeometries;if(m&&null!=i)for(const e in i){const r=i[e],t=m[e],s=t?.spatialReference;null==r||s||(r.spatialReference=o);}s.push(p);}return s}};e$2([y$1({type:[s$3],json:{write:!0}})],c$5.prototype,"features",void 0),e$2([o$8("features")],c$5.prototype,"readFeatures",null),c$5=e$2([a$3("esri.rest.support.AggregateFeatureSet")],c$5);const m$4=c$5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let s$2 = class s{constructor(){this._instanceById=new Map;}destroy(){this._instanceById.clear();}get size(){return this._instanceById.size}entries(){return this._instanceById.entries()}updateStart(){this._instanceByIdNext=new Map;}updateEnd(){if(!this._instanceByIdNext)throw new Error("InternalError: Found updateEnd call without corresponding updateStart");for(const t of this._instanceById.keys())this._instanceByIdNext.has(t)||this._instanceById.delete(t);for(const[t,n]of this._instanceByIdNext.entries()){const e=this._instanceById.get(t);e?e.setInput(n.getInput()):this._instanceById.set(t,n);}this._instanceByIdNext=null;}values(){return this._instanceById.values()}ensureInstance(s,i){let r;if("object"==typeof i&&"optionalAttributes"in i&&"uniforms"in i){r=`${s.type}${JSON.stringify(i.optionalAttributes)}`;const t=i.uniforms;if("object"==typeof t)for(const n in t)r+=`${n}.${null!=t[n]}`;}else r=`${s.type}.${JSON.stringify(i)}`;const a=l$9(r);if(this._instanceByIdNext){const t=new i$3(r$5(a),s,i);return this._instanceByIdNext.set(a,t),t}if(!this._instanceById.has(a)){const t=new i$3(r$5(a),s,i);this._instanceById.set(a,t);}return this._instanceById.get(a)}getInstance(t){return this._instanceById.get(t)}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
const l$8=1e3;let d$2 = class d{constructor(t,i,s){this.getStage=t,this.version=i,this._tileInfoView=s,this._pendingUpdates=new t$5(l$8),this._locked=!1,this._tiles=new Map;}destroy(){for(const e of this.tiles())e.destroy();this._pendingUpdates.clear(),this._tiles.clear();}tiles(){return this._tiles.values()}size(){return this._tiles.size}setTiles(e){this._tiles.clear();for(const t of e)this._tiles.set(t.key.id,t);}lockUploads(){this._locked=!0;}unlockUploads(){this._locked=!1,this.flush();}enqueueUpdate(e){this._pendingUpdates.enqueue(e);}update(e){if(!this._locked)for(;this._pendingUpdates.size;){const t=this._pendingUpdates.peek();if(null==t||t.attributeEpoch>e)break;this._updateTile(t),this._pendingUpdates.dequeue();}}removeTile(e){const t=this._tiles.get(e);has("esri-2d-update-debug")&&console.debug(`Tile[${e}] RenderState.removeTile`),t?.destroy(),this._tiles.delete(e);}isTileDone(e){const t=this._tiles.get(e.id);return !!t&&t.isReady}flush(){for(;this._pendingUpdates.size;){const e=this._pendingUpdates.dequeue();null!=e&&this._updateTile(e);}for(const e of this._tiles.values())e.upload();}_updateTile(e){if(has("esri-2d-update-debug")){const t=e.debugInfo?.chunkId??"<EnsureEnd>";console.debug(`Version[${e.version}] Tile[${e.id}] Chunk[${t}] RenderState.updateTile [${e.type}]`,e);}const t=this._ensureTile(e.id);if("update"===e.type){const[i,...s]=e.modify;t.onMessage({type:"update",modify:i,remove:e.remove,end:e.end,attributeEpoch:e.attributeEpoch});for(const t of s){const i=this._tiles.get(t.tileId);i&&i.onMessage({type:"update",modify:t,remove:e.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null});}return}if(null==e.append)return void t.onMessage({type:"append",clear:e.clear,debugInfo:e.debugInfo,end:e.end,attributeEpoch:e.attributeEpoch});const[i,...s]=e.append;t.onMessage({type:"append",clear:e.clear,append:i,debugInfo:e.debugInfo,end:e.end,attributeEpoch:e.attributeEpoch});for(const o of s){const e=this._tiles.get(o.tileId);e&&e.onMessage({type:"update",modify:o,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null});}}_ensureTile(e){if(!this._tiles.has(e)){const t=this._createTile(e);this._copyPixelBufferedEntitiesInto(t),this._tiles.set(e,t);}return this._tiles.get(e)}_createTile(e){has("esri-2d-update-debug")&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);const r=new e$3(e),l=this._tileInfoView.getTileBounds(u$8(),r),d=this._tileInfoView.getTileResolution(r.level),a=new b(r,d,l[0],l[3],!0);if(a.stage=this.getStage(),!a.stage){const e=new s$4("featurelayerview:webgl","Cannot create tile with empty stage");n$5.getLogger("esri.views.2d.layers.features.RenderState").error(e);}return a}_copyPixelBufferedEntitiesInto(e){let t=7;for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){if(0===i&&0===s)continue;const o=this._tileInfoView.tileInfo.isWrappable,n=o$9(e.key,s,i,o).id,l=this._tiles.get(n);if(null!=l){const o=1<<t;e.copyPixelBufferedEntitesFrom(l,o,s,i);}t--;}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let l$7 = class l{constructor(e,s){this.id=e,this.version=s,this._resolver=L$1(),this._done=!1;}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0;}destroy(){this._resolver.reject();}};let u$7 = class u extends r$6{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new h,this._hitTestsRequests=[],this._store=new s$2,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._layerView=e;}renderChildren(e){if(this.attributeView.update(),this._renderState?.update(this.attributeView.currentEpoch),this._renderState){const e=Array.from(this._renderState.tiles()).filter((e=>e.needsUpload));if(e.length){e[Math.floor(Math.random()*e.length)].upload(),e.length>=2&&this.requestRender();}for(const t of this._renderState.tiles())t.tryReady(this.attributeView.currentEpoch)&&(this._subscriptions.get(t.key.id)?.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this.requestRender());}for(const t of this.children)t.setTransform(e.state);if(this.hasAnimation){e.painter.effects.integrate.draw(e,e.attributeView);}switch(super.renderChildren(e),e.drawPhase){case E$1.MAP:return this._renderMapPhase(e);case E$1.HIGHLIGHT:return this._renderHighlightPhase(e);case E$1.LABEL:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight()}get _layer(){return this._layerView.layer}_getExclusivePostprocessingInstance({drawPhase:e}){if(null==this._instanceStore)return null;let t=0,s=null;for(const i of this._instanceStore.values())i.techniqueRef.drawPhase&e&&(t++,i.techniqueRef.postProcessingEnabled&&(s=i));return t>1?null:s}_getOverrideStencilRef({drawPhase:e}){if(null==this._instanceStore)return null;let t=null;for(const s of this._instanceStore.values()){if(!(s.techniqueRef.drawPhase&e))continue;const{overrideStencilRef:i}=s.techniqueRef;if(null==t)t=i;else if(t!==i){t=null;break}}return t}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter((e=>this._visibleTiles.has(e.key.id))):[]}updateAttributeView(e){this.requestRender(),this.attributeView.requestUpdate(e),this.hasLabels&&this._layerView.view.labelManager.requestUpdate();}updateSubscriptions(e){for(const{tileId:t,version:s}of e.subscribe)if(this._subscriptions.has(t))this._subscriptions.get(t).version=s;else {const e=new l$7(t,s);this._subscriptions.set(t,e),this.updatingHandles.addPromise(e.promise);}for(const t of e.unsubscribe){const e=this._subscriptions.get(t);e?.destroy(),this._subscriptions.delete(t),this.removeTile(t);}}isDone(e){return !!this._renderState&&this._renderState.isTileDone(e)}async updateRenderState(e){has("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),this._renderStateNext=new d$2((()=>this._stage),e,this._tileInfoView);}getDisplayStatistics(e,t){const s=this._statisticsByLevel.get(e);return s?s.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let s=this._statisticsByLevel.get(e);s||(s=new Map,this._statisticsByLevel.set(e,s));for(const i of t)s.set(i.fieldName,{minValue:i.minValue,maxValue:i.maxValue});}editStart(){this._renderState?.lockUploads(),this.attributeView.lockTextureUploads(),this._lockStatisticUpdates=!0;}editEnd(){this._renderState?.unlockUploads(),this.attributeView.unlockTextureUploads(),this._lockStatisticUpdates=!1;for(const e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this.requestRender();}swapRenderState(){this._renderStateNext&&(has("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`),this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderStateNext=null),this._renderState&&this._renderState.flush(),this.requestRender();}setVisibleTiles(e){this._visibleTiles=e;}async onMessage(t,s){s$5(s);const i=t.inner;if(!this._subscriptions.has(i.id))return;const r=this._subscriptions.get(i.id);if(r.version!==i.subscriptionVesrion){if(has("esri-2d-update-debug")){const e=`${i.subscriptionVesrion} != ${r.version}`;console.debug(`Version[${e}] Tile[${i.id}] FeatureContainer - Dropping message, outdated version]`,i);}return}const n=this._renderStateNext??this._renderState;if(!n)throw new Error("InternalError: No renderState defined");n.version!==i.version&&console.error(`InternalError: Version mismatch. [renderState: ${n.version}, message: ${i.version}]`),n.enqueueUpdate(i),this.requestRender(),this._layerView.view.labelManager.requestUpdate(),this._layerView.requestUpdate();}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e));}hitTest(e){let s=this._hitTestsRequests.find((({x:t,y:s})=>t===e.x&&s===e.y));const i=L$1();return s?s.resolvers.push(i):(s={x:e.x,y:e.y,resolvers:[i]},this._hitTestsRequests.push(s)),this.requestRender(),i.promise}getSortKeys(e){const t=new Set(e),s=new Map;for(const i of this.children)if(i.getSortKeys(t).forEach(((e,t)=>s.set(t,e))),s.size===t.size)break;return s}get hasAnimation(){return this.hasLabels}updateTransitionProperties(e,t){super.updateTransitionProperties(e,t),this._layerView.featureEffectView.transitionStep(e,t),this._layerView.featureEffectView.transitioning&&this.requestRender();}doRender(e){const{minScale:t,maxScale:s}=this._layer.effectiveScaleRange,i=e.state.scale;i<=(t||1/0)&&i>=s&&super.doRender(e);}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender();}setStencilReference(e){const t=this._getOverrideStencilRef(e);if(null==t)super.setStencilReference(e);else for(const s of this.children)s.stencilRef=t(s);}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,R$1.All),this._hitTestsRequests.length>0&&this._renderHittest(e);}_renderHighlightPhase(e){this.hasHighlight&&a$4(e,!1,(e=>{this._renderFeatures(e,R$1.Highlight);}));}_renderLabelPhase(e){this._renderFeatures(e,R$1.All);}_renderInsideEffect(e){const t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,R$1.InsideEffect),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind();}_renderOutsideEffect(e){const t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,R$1.OutsideEffect),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind();}_renderHittest(e){const{context:t}=e,s=e.painter.effects.hittest,i=t.getBoundFramebufferObject(),a=t.getViewport(),o=e.passOptions,h=e.drawPhase;s.bind(e),e.passOptions=s.createOptions(e,this._hitTestsRequests),e.drawPhase=E$1.HITTEST;const{distance:d,smallSymbolDistance:l}=e.passOptions,u=Math.max(d,l);for(const r of this.children)r.visible&&r.containsScreenPoint(e.state,e.passOptions.position,2*u)&&this._renderTile(r,e,R$1.All);s.draw(e),s.unbind(),t.bindFramebuffer(i),t.restoreViewport(a),e.passOptions=o,e.drawPhase=h;}_renderFeatures(e,t){for(const i of this.children)i.visible&&this._renderTile(i,e,t);const s=this._getExclusivePostprocessingInstance(e);null!=s&&s.techniqueRef.postProcess(e,s);}_renderTile(e,t,s){const i=has("featurelayer-force-marker-text-draw-order")?N.STRICT_MARKERS_AND_TEXT:N.BATCHING,r=e.getDisplayList(this._instanceStore,i);t.selection=s,r?.render(t);}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
async function t$4(t){const o=await p$4("FeaturePipelineWorker",{client:t,strategy:"dedicated"});return new n$4(o)}let n$4 = class n{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy("features"),this.aggregates=this._connection.createInvokeProxy("aggregates"),this.streamMessenger=this._connection.createInvokeProxy("streamMessenger");}destroy(){this._connection.destroy();}get closed(){return this._connection.closed}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
const n$3=10;let l$6=class l extends S{constructor(){super(...arguments),this.events=new o$a,this._updatingStrategy=!0,this._tileToEvent=new s$6,this._fetchStatus={outstanding:0,done:0};}get hasAllFeatures(){return this._hasAllData()&&(this._strategyInfo?.willQueryAllFeatures??!1)}get hasAllFeaturesInView(){return this._hasAllData()}get hasFullGeometries(){return this._hasAllData()&&(this._strategyInfo?.willQueryFullResolutionGeometry??!1)}onEvent(t){switch(t.type){case"subscribe":case"unsubscribe":case"loaded":case"error":this._handleTileEvent(t);break;case"updateStrategyStart":this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=t.about;break;case"updateStrategyEnd":this._updatingStrategy=!1;break;case"updateFieldsStart":this._fetchStatus={done:0,outstanding:0};break;case"updateFieldsEnd":break;case"updateFieldsError":this.events.emit("error",t);break;case"fetchStart":this._fetchStatus.outstanding+=1,this.events.emit("status",this._fetchStatus);break;case"fetchEnd":this._fetchStatus.done+=1,this.events.emit("status",this._fetchStatus),t.done&&(this._fetchStatus={done:0,outstanding:0});}}_hasAllData(){return !this._updatingStrategy&&this._hasAllTileData()}_hasAllTileData(){for(const t of this._tileToEvent.values()){const e=t.peekLast();if("loaded"!==e?.type)return !1}return !0}_handleTileEvent(t){switch(t.type){case"subscribe":{const e=new t$5(n$3);e.enqueue(t),this._tileToEvent.set(t.tile,e);break}case"unsubscribe":this._tileToEvent.delete(t.tile);break;case"loaded":{const e=this._tileToEvent.get(t.tile);if(!e)return;e.enqueue(t),this._tileToEvent.set(t.tile,e);break}case"error":{const e=this._tileToEvent.get(t.tile);if(!e)return;e.enqueue(t),this._tileToEvent.set(t.tile,e),this.events.emit("error",t);break}}}};e$2([y$1({readOnly:!0})],l$6.prototype,"hasAllFeatures",null),e$2([y$1({readOnly:!0})],l$6.prototype,"hasAllFeaturesInView",null),e$2([y$1({readOnly:!0})],l$6.prototype,"hasFullGeometries",null),e$2([y$1()],l$6.prototype,"_updatingStrategy",void 0),e$2([y$1()],l$6.prototype,"_strategyInfo",void 0),e$2([y$1()],l$6.prototype,"_tileToEvent",void 0),l$6=e$2([a$3("esri.views.2d.layers.features.FeatureSourceEventLog")],l$6);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function e$1(e){switch(e.geometryType){case"point":return "esriGeometryPoint";case"polyline":return "esriGeometryPolyline";case"polygon":case"multipatch":return "esriGeometryPolygon";case"multipoint":return "esriGeometryMultipoint";default:return null}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function e(e,a){const c=e.featureReduction;return c&&"selection"!==c.type&&(!("maxScale"in c)||!c.maxScale||c.maxScale<a.scale)?c:null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
const r$3=Math.PI;function i$2(e,t){switch(t.transformationType){case i$4.Additive:return s$1(e,t);case i$4.Constant:return o$7(t,e);case i$4.ClampedLinear:return u$6(e,t);case i$4.Proportional:return l$5(e,t);case i$4.Stops:return c$4(e,t);case i$4.RealWorldSize:return m$3(e,t);case i$4.Identity:return e;case i$4.Unknown:return null}}function a$2(e,t){return "number"==typeof e?e:i$2(t,e)}function s$1(e,t){return e+(a$2(t.minSize,e)||t.minDataValue)}function o$7(e,t){const n=e.stops;let r=n?.length&&n[0].size;return null==r&&(r=e.minSize),a$2(r,t)}function u$6(e,t){const n=t.minDataValue,r=t.maxDataValue,i=(e-n)/(r-n),s=a$2(t.minSize,e),o=a$2(t.maxSize,e);return e<=n?s:e>=r?o:s+i*(o-s)}function l$5(t,n){const r=t/n.minDataValue,i=a$2(n.minSize,t),s=a$2(n.maxSize,t);let o=null;return o=r*i,e$4(o,i,s)}function c$4(e,t){const[n,r,i]=p$2(e,t.cache.ipData);if(n===r)return a$2(t.stops[n].size,e);{const s=a$2(t.stops[n].size,e);return s+(a$2(t.stops[r].size,e)-s)*i}}function m$3(n,i){const s=m$5[i.valueUnit],o=a$2(i.minSize,n),u=a$2(i.maxSize,n),{valueRepresentation:l}=i;let c=null;return c="area"===l?2*Math.sqrt(n/r$3)/s:"radius"===l||"distance"===l?2*n/s:n/s,e$4(c,o,u)}function p$2(e,t){if(!t)return;let n=0,r=t.length-1;return t.some(((t,i)=>e<t?(r=i,!0):(n=i,!1))),[n,r,(e-t[n])/(t[r]-t[n])]}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function l$4(n){return (n.labelsVisible&&n.labelingInfo?.every((n=>"none"!==n.deconflictionStrategy)))??!1}function r$2(n,i){const l=e(n,i);if(l?.labelsVisible&&l.labelingInfo?.length)return l.labelingInfo.every((n=>"none"!==n.deconflictionStrategy))}function t$3(e){return l=>u$9(i$2(l,e))}function o$6(n){const e=null!=n&&"visualVariables"in n&&n.visualVariables;if(!e)return null;for(const i of e)if("size"===i.type)return t$3(i);return null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function t$2(t,i,s,o){const r=null!=t.subtypeCode?`${t.subtypeField} = ${t.subtypeCode}`:null,n=n$6(t.definitionExpression,r),a=t.customParameters??{};return o&&(a.token=o),{type:"feature",mutable:{sourceRefreshVersion:s,availableFields:i.availableFields,dataFilter:{queryScaleRanges:t.queryScaleRanges??[],definitionExpression:n,gdbVersion:t.gdbVersion,historicMoment:t.historicMoment?.getTime(),timeExtent:t.timeExtent?.toJSON(),customParameters:a}}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function u$5(n,r,t=0){if(null==r)return n[t]=0,n[t+1]=0,n[t+2]=0,void(n[t+3]=0);const{r:o,g:u,b:i,a:c}=r;n[t]=o*c/255,n[t+1]=u*c/255,n[t+2]=i*c/255,n[t+3]=c;}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
async function M(i,a){if(!i)return [];switch(i.type){case"simple-fill":return P(i,a);case"picture-fill":return U(i,a);case"simple-marker":return w(i,a);case"picture-marker":return A(i,a);case"simple-line":return B(i,a,!1);case"text":return R(i,a);case"label":return k(i,a);case"cim":return n$7(i.data,a);case"web-style":{const e=await i.fetchCIMSymbol();return n$7(e.data,a)}case"line-3d":return n$5.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${i.type}" unsupported in MapView. Defaulting to simple-line`),B(new d$5,a,!1);case"point-3d":return n$5.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${i.type}" unsupported in MapView. Defaulting to simple-marker`),w(new y$2,a);case"polygon-3d":return n$5.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${i.type}" unsupported in MapView. Defaulting to simple-fill`),P(new S$1,a);case"mesh-3d":case"label-3d":return n$5.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${i.type}" unsupported in MapView. Ignoring`),[];case"CIMSymbolReference":throw new Error("InternalError: CIMSymbolReference should already be resolved")}}async function x(e,i){const{schemaOptions:a}=i,{store:l}=a,r=new Array(G),t=new Array(G/4);for(let u=0;u<G;u++){const i=u<e.attributes.length?e.attributes[u].color:null;r[u]=[0,0,0,0],u$5(r[u],i);}for(let u=0;u<G/4;u++)t[u]=[0,0,0,0],t[u][0]=4*u<e.attributes.length?1:0,t[u][1]=4*u+1<e.attributes.length?1:0,t[u][2]=4*u+2<e.attributes.length?1:0,t[u][3]=4*u+3<e.attributes.length?1:0;const o={uniforms:{isActive:t,colors:r,dotValue:e.dotValue,dotScale:e.referenceScale,blending:e.dotBlendingEnabled,dotSize:e.dotSize,seed:e.seed},optionalAttributes:{}},s=l.ensureInstance(h$2.dotDensity,o).createMeshInfo({effects:null}),n=[];if(e.backgroundColor){const a=new S$1({color:e.backgroundColor,outline:null}),l=await M(a,i);n.push(...l);}if(n.push(s),e.outline){const a=B(e.outline,i,!0);n.push(...a);}return n}async function C(e,l){const{store:r}=l,{radius:t,minDensity:o,maxDensity:s,referenceScale:n,field:u,valueExpression:c,colorStops:p}=e,b=f$3(p);return [r.ensureInstance(h$2.heatmap,{uniforms:{radius:u$9(t),minDensity:o,maxDensity:s,referenceScale:n,isFieldActive:!(!u&&!c),gradient:b,gradientHash:b.join(",")},optionalAttributes:{}}).createMeshInfo({effects:null})]}function I(e,a){const{store:l}=a,r=e.outline?.width||0,t=M$1(e),o=l.ensureInstance(h$2.pieChart,{uniforms:{shader:{outlineWidth:Math.round(u$9(r)),defaultColor:t$6(e.defaultColor),outlineColor:t$6(e.outline?.color),othersColor:t$6(e.othersCategory?.color),donutRatio:e.holePercentage,sectorThreshold:e.othersCategory?.threshold||0,colors:e.attributes.map((e=>t$6(e.color))),visualVariableOpacity:t.visualVariableOpacity,visualVariableSizeMinMaxValue:t.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:t.visualVariableSizeScaleStops,visualVariableSizeStops:t.visualVariableSizeStops,visualVariableSizeUnitValue:t.visualVariableSizeUnitValue,hittestUniforms:null},numberOfFields:e.attributes.length},optionalAttributes:{}}).createMeshInfo({size:e.size,outlineWidth:r,effects:null,scaleInfo:null,minPixelBuffer:h$3(t)});return [...e.backgroundFillSymbol?P(e.backgroundFillSymbol,{schemaOptions:a,path:"",uniforms:x$1}):[],o]}function O(e){if("path"===e.style){if(null==e.path)throw new Error("Symbol with a style of type path must define a path");return {type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:e.path,asFill:!0}}}const i=ee$1.fromSimpleMarker(e);if("outline"in e&&e.outline&&"none"!==e.outline.style){if("solid"!==e.outline.style){if(!i||!i.symbolLayers)throw new Error("Error handling marker! ");return {type:"sprite-rasterization-param",resource:i.symbolLayers[0],overrides:[]}}}return {type:"sprite-rasterization-param",resource:l$a(i),overrides:[]}}async function w(e,i){const{uniforms:a,schemaOptions:r}=i,{store:t}=r;if("path"===e.style||e.outline&&"solid"!==e.outline.style&&"none"!==e.outline.style){const r=ee$1.fromSimpleMarker(e);if(!r||!r.symbolLayers)throw new Error("Error handling marker! ");if(a.visualVariableRotation&&(r.angleAlignment="Map"),"path"!==e.style){const e=r.symbolLayers[0];if(a$5(i.uniforms)){const a=h$3(i.uniforms,0,1);if(a>e.size){const i=a/e.size;e.size=a;const l=e.markerGraphics?.[0].symbol;(l.symbolLayers&&l.symbolLayers[0]).width*=i;}}}return n$7({type:"CIMSymbolReference",symbol:r},i)}const s=t.ensureInstance(h$2.marker,{uniforms:{visualVariableColor:a.visualVariableColor,visualVariableOpacity:a.visualVariableOpacity,visualVariableSizeMinMaxValue:a.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:a.visualVariableSizeScaleStops,visualVariableSizeStops:a.visualVariableSizeStops,visualVariableSizeUnitValue:a.visualVariableSizeUnitValue,visualVariableRotation:a.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),n=O(e);let u=e.color?.toArray()??[0,0,0,0];"CIMVectorMarker"===n.resource.type&&(u=[255,255,255,255]);const c="triangle"===e.style?124/116:1,p=e.size,b=p*c,m=null!=a.visualVariableColor&&("cross"===e.style||"x"===e.style);return [s.createMeshInfo({type:"simple",color:u,height:p,width:b,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:i$5(a)?i$6.MAP:i$6.SCREEN,outlineColor:e.outline?.color?.toArray()??[0,0,0,0],outlineSize:e.outline?.width??1,referenceSize:p,sprite:n,overrideOutlineColor:m,hasSizeVV:a$5(a),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:h$3(a)})]}function A(e,i){const{uniforms:a,schemaOptions:r}=i,{store:t}=r,s=t.ensureInstance(h$2.marker,{uniforms:{visualVariableColor:a.visualVariableColor,visualVariableOpacity:a.visualVariableOpacity,visualVariableSizeMinMaxValue:a.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:a.visualVariableSizeScaleStops,visualVariableSizeStops:a.visualVariableSizeStops,visualVariableSizeUnitValue:a.visualVariableSizeUnitValue,visualVariableRotation:a.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),n=ee$1.createPictureMarkerRasterizationParam(e);if(!n)return [];return [s.createMeshInfo({type:"picture",color:[255,255,255,255],height:e.height,width:e.width,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:i$5(a)?i$6.MAP:i$6.SCREEN,outlineColor:null,outlineSize:0,referenceSize:e.height,sprite:n,overrideOutlineColor:!1,hasSizeVV:a$5(a),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:h$3(a)})]}function L(e,i,a){const{uniforms:l,schemaOptions:r}=a,{store:t}=r,n=t.ensureInstance(h$2.marker,{uniforms:{visualVariableColor:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity,visualVariableSizeMinMaxValue:l.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:l.visualVariableSizeScaleStops,visualVariableSizeStops:l.visualVariableSizeStops,visualVariableSizeUnitValue:l.visualVariableSizeUnitValue,visualVariableRotation:l.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),u=O(e),c=6,p=c*i.width,b=p,m=e.color?.toArray()??i.color?.toArray()??[0,0,0,0],V="cross"===e.style||"x"===e.style;let y;switch(e.placement){case"begin-end":y=o$c.Both;break;case"begin":y=o$c.JustBegin;break;case"end":y=o$c.JustEnd;break;default:y=o$c.None;}const z={type:"cim-marker-placement-param",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:y,offsetAlongLine:0},overrides:[]};return [n.createMeshInfo({type:"simple",color:m,height:b,width:p,offsetX:0,offsetY:0,angle:0,alignment:i$5(l)?i$6.MAP:i$6.SCREEN,outlineColor:m,outlineSize:V?i.width:0,referenceSize:b/c,sprite:u,overrideOutlineColor:V&&null!=l.visualVariableColor,hasSizeVV:a$5(l),placement:z,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:h$3(l)})]}function R(e,i){const{uniforms:a,schemaOptions:r}=i,{store:t}=r;return [t.ensureInstance(h$2.text,{uniforms:{visualVariableColor:a.visualVariableColor,visualVariableOpacity:a.visualVariableOpacity,visualVariableRotation:a.visualVariableRotation,visualVariableSizeMinMaxValue:a.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:a.visualVariableSizeScaleStops,visualVariableSizeStops:a.visualVariableSizeStops,visualVariableSizeUnitValue:a.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1,clipAngle:!1,referenceSymbol:!1}}).createMeshInfo({boxBackgroundColor:e.backgroundColor?.toArray(),boxBorderLineColor:e.borderLineColor?.toArray(),boxBorderLineSize:e.borderLineSize??0,color:e.color?.toArray()??[0,0,0,0],offsetX:e.xoffset,offsetY:e.yoffset,postAngle:e.angle,fontSize:e.font.size,decoration:e.font.decoration,haloColor:e.haloColor?.toArray()??[0,0,0,0],haloFontSize:e.haloSize??0,lineWidth:e.lineWidth,lineHeightRatio:e.lineHeight,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:e.font.toJSON(),textString:e.text,symbol:ee$1.createCIMTextSymbolfromTextSymbol(e)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:h$3(a),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1})]}function k(e,a){const{schemaOptions:r,uniforms:t}=a,{store:o}=r,s=e.symbol,{allowOverrun:n,repeatLabel:c,repeatLabelDistance:p}=e,b={maxScale:e.maxScale??0,minScale:e.minScale??0},m=o.ensureInstance(h$2.label,{uniforms:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:t.visualVariableRotation,visualVariableSizeMinMaxValue:t.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:t.visualVariableSizeScaleStops,visualVariableSizeStops:t.visualVariableSizeStops,visualVariableSizeUnitValue:t.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!0,clipAngle:!0,referenceSymbol:!0}}),V=e.labelPlacement,[y,v]=o$b(V);return [m.createMeshInfo({boxBackgroundColor:s.backgroundColor?.toArray(),boxBorderLineColor:s.borderLineColor?.toArray(),boxBorderLineSize:s.borderLineSize??0,color:s.color?.toArray()??[0,0,0,0],offsetX:s.xoffset,offsetY:s.yoffset,postAngle:s.angle,fontSize:s.font.size,decoration:s.font.decoration,haloColor:s.haloColor?.toArray()??[0,0,0,0],haloFontSize:s.haloSize??0,lineWidth:s.lineWidth,lineHeightRatio:s.lineHeight,horizontalAlignment:y,verticalAlignment:v,repeatLabel:c,repeatLabelDistance:u$9(p),allowOverrun:n,labelPosition:e.labelPosition,scaleInfo:b,minPixelBuffer:h$3(t),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:s.font.toJSON(),textString:s.text,symbol:ee$1.createCIMTextSymbolfromTextSymbol(s),primitiveName:"label-override"},useLegacyLabelEvaluationRules:null==e.labelExpressionInfo?.expression,overrides:[{type:"CIMPrimitiveOverride",valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.labelExpressionInfo?.expression??e.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1,isLineLabel:!1})]}function j(e,i){const a=e.width;return {outlineColor:e.color?.toArray()||[0,0,0,1],width:a,referenceWidth:a,capType:e.cap??"round",joinType:e.join??"round",miterLimit:e.miterLimit,hasSizeVV:i}}function E(e,i){const{uniforms:a,schemaOptions:l}=i,{store:r}=l,t=e.color?.toArray()??[0,0,0,0],o={type:"sprite-rasterization-param",resource:{type:"fill-style",style:e.style},overrides:[]};if("solid"===e.outline?.style){return [r.ensureInstance(h$2.patternOutlineFill,{uniforms:{visualVariableColor:a.visualVariableColor,visualVariableOpacity:a.visualVariableOpacity,visualVariableSizeScaleStops:a.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:t,...j(e.outline,!!a.visualVariableSizeOutlineScaleStops),sprite:o,scaleInfo:null,effects:null})]}const s=[],n=r.ensureInstance(h$2.patternFill,{uniforms:{visualVariableColor:a.visualVariableColor,visualVariableOpacity:a.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:e.color?.toArray()??[0,0,0,0],sprite:o,scaleInfo:null,effects:null});return s.push(n),e.outline&&s.push(...B(e.outline,i,!0)),s}function F(e,i){const{uniforms:a,schemaOptions:l}=i,{store:r}=l,t=e.color?.toArray()??[0,0,0,0];if("none"!==e.style&&"solid"===e.outline?.style){return [r.ensureInstance(h$2.outlineFill,{uniforms:{visualVariableColor:a.visualVariableColor,visualVariableOpacity:a.visualVariableOpacity,visualVariableSizeScaleStops:a.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:t,...j(e.outline,!!a.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null})]}const o=[];if("none"!==e.style){const e=r.ensureInstance(h$2.fill,{uniforms:{visualVariableColor:a.visualVariableColor,visualVariableOpacity:a.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:t,scaleInfo:null,effects:null});o.push(e);}return e.outline&&o.push(...B(e.outline,i,!0)),o}function P(e,i){const{style:a}=e;return a&&"none"!==a&&"solid"!==a?E(e,i):F(e,i)}function U(e,i){const{outline:a}=e,{uniforms:r,schemaOptions:t}=i,{store:o}=t,s=[],n=ee$1.createPictureFillRasterizationParam(e);if(!n)return [];const{width:u,height:c,xoffset:p,yoffset:b,xscale:m,yscale:S}=e,V={color:[255,255,255,255],sprite:n,height:c,aspectRatio:u/c,offsetX:p,offsetY:b,scaleX:m,scaleY:S,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if("solid"===a?.style){return [o.ensureInstance(h$2.complexOutlineFill,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeScaleStops:r.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({...V,...j(a,!!r.visualVariableSizeOutlineScaleStops)})]}const y=o.ensureInstance(h$2.complexFill,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity},optionalAttributes:{zoomRange:!1}});return s.push(y.createMeshInfo(V)),a&&s.push(...B(a,i,!0)),s}function B(e,i,a){const{color:l,style:o,width:s,cap:n,join:u}=e,{schemaOptions:c}=i,{store:p}=c,b=[],m=a?{...x$1,visualVariableSizeScaleStops:i.uniforms.visualVariableSizeOutlineScaleStops}:i.uniforms,S={uniforms:{visualVariableColor:m.visualVariableColor,visualVariableOpacity:m.visualVariableOpacity,visualVariableSizeMinMaxValue:m.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:m.visualVariableSizeScaleStops,visualVariableSizeStops:m.visualVariableSizeStops,visualVariableSizeUnitValue:m.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1}},y={color:l?.toArray()??[0,0,0,0],width:s,referenceWidth:s,capType:n,joinType:u,miterLimit:e.miterLimit,hasSizeVV:a$5(m),effects:null,scaleInfo:null};if(null==o||"solid"===o){const e=p.ensureInstance(h$2.line,S).createMeshInfo(y);b.push(e);}else if("none"!==o){const e=p.ensureInstance(h$2.texturedLine,S).createMeshInfo({...y,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:me(o,n),capStyle:re$1(n)},overrides:[]}});b.push(e);}return null!=e.marker&&b.push(...L(e.marker,e,i)),b}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
async function l$3(a,l,r){const n=l.labelsVisible&&l.labelingInfo||[],i=e$1(l),m=a$6(n,i);return {type:"label",classes:await Promise.all(m.map(((e,s)=>o$5(a,e,s,r))))}}async function o$5(e,s,l,o){const r=await M(s,{path:`${l}`,schemaOptions:e,uniforms:o});return {maxScale:s.maxScale,minScale:s.minScale,expression:s.labelExpressionInfo?.expression??s.labelExpression,where:s.where,meshes:r}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
async function r$1(e,a){if(!a)return {type:"simple",meshes:[]};switch(a.type){case"simple":return o$4(e,a);case"dot-density":return u$4(e,a);case"class-breaks":return m$2(e,a);case"unique-value":return c$3(e,a);case"dictionary":return p$1(a);case"heatmap":return f$1(e,a);case"pie-chart":return y(e,a)}}async function o$4(a,l){const n=l.getSymbols(),s=n.length?n[0]:null,r=M$1(l),t="renderer.symbol";return {type:"simple",meshes:await M(s,{schemaOptions:a,uniforms:r,path:t})}}async function u$4(a,i){const n=M$1(i),s="renderer.symbol";return {type:"dot-density",meshes:await x(i,{schemaOptions:a,uniforms:n,path:s})}}async function m$2(l,n){const s=M$1(n),r=n.backgroundFillSymbol,t=n.normalizationType,o="log"===t?"esriNormalizeByLog":"percent-of-total"===t?"esriNormalizeByPercentOfTotal":"field"===t?"esriNormalizeByField":null,u=n.classBreakInfos.map((async e=>({meshes:await M(e.symbol,{path:`renderer-stop-${e.minValue}-${e.maxValue}`,schemaOptions:l,uniforms:s}),min:e.minValue,max:e.maxValue}))),m=(await Promise.all(u)).sort(((e,a)=>e.min-a.min)),c=await M(r,{schemaOptions:l,path:"renderer.backgroundFill",uniforms:{...x$1,visualVariableSizeOutlineScaleStops:s.visualVariableSizeOutlineScaleStops}}),p=await M(n.defaultSymbol,{schemaOptions:l,path:"renderer.defaultSymbol",uniforms:s});return {type:"interval",field:n.field,expression:n.valueExpression,backgroundFill:c,defaultSymbol:p,intervals:m,normalizationField:n.normalizationField,normalizationTotal:n.normalizationTotal,normalizationType:o,isMaxInclusive:n.isMaxInclusive}}async function c$3(l,n){const s=[],r=M$1(n),t=await M(n.backgroundFillSymbol,{schemaOptions:l,path:"renderer.backgroundFill",uniforms:{...x$1,visualVariableSizeOutlineScaleStops:r.visualVariableSizeOutlineScaleStops}}),o=await M(n.defaultSymbol,{schemaOptions:l,path:"renderer.defaultSymbol",uniforms:r});for(const e of n.uniqueValueInfos??[]){const a=await M(e.symbol,{path:`renderer-unique-value-${e.value}`,schemaOptions:l,uniforms:r});s.push({value:""+e.value,symbol:a});}return {type:"map",field:n.field,expression:n.valueExpression,field2:n.field2,field3:n.field3,fieldDelimiter:n.fieldDelimiter,backgroundFill:t,defaultSymbol:o,map:s}}function p$1(a){const i=M$1(a),l=a.scaleExpression,n=null!=l&&"1"!==l?{valueExpressionInfo:{type:"CIMExpressionInfo",expression:a.scaleExpression,returnType:"Numeric"},defaultValue:1}:void 0;return {type:"dictionary",fieldMap:a.fieldMap,scaleExpression:n,visualVariableUniforms:i}}async function f$1(e,a){return {type:"heatmap",meshes:await C(a,e)}}async function y(e,a){return {type:"pie-chart",meshes:I(a,e)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
async function l$2(e,r){const s=r.renderer,l=M$1(s);return {symbology:await r$1(e,s),labels:await l$3(e,r,l)}}async function a$1(e,r,t,i){const n=t.featureReduction;if(n)switch(n.type){case"binning":return u$3(n,e,r,t,i);case"cluster":return f(n,e,r,t,i)}const a=d$1(t.orderBy,t.renderer,t.objectIdField),o=t$7(t.renderer,r.filters),c=await l$2(e,t),y=!1;return {storage:o,mesh:{properties:{sortKey:a,timeZone:r.timeZone,returnMeshObjectId:y,displayRefreshVersion:i},strategy:{type:"feature"},factory:c}}}function o$3(e,r){return e.fields.map((e=>({...e.toJSON(),type:c$2(e,r)})))}function c$2(e,r){const{onStatisticExpression:t,onStatisticField:i,statisticType:s}=e;switch(s){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return "esriFieldTypeDouble";case"mode":{if(t){const{returnType:e}=t;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=r.find((e=>e.name===i));return e?e.type:"esriFieldTypeString"}}}async function u$3(r,l,a,c,u){const f=o$3(r,c.fields),d=r.renderer,y=await r$1(l,d),p=t$7(d,[null,null]),m=M$1(d),g=await l$3(l,{geometryType:"polygon",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},m),b=!1,h="geohash"===r.binType?{type:"geohash",fixBinLevel:r.fixedBinLevel??3}:{type:"grid",size:u$9(r.size),fixedBinLevel:r.fixedBinLevel};return {storage:p,mesh:{properties:{sortKey:null,timeZone:a.timeZone,returnMeshObjectId:b,displayRefreshVersion:u},strategy:{type:"binning",fields:f,index:h,featureFilter:a.filters[0]},factory:{labels:g,symbology:y}}}}async function f(r,l,a,c,u){const f=o$3(r,c.fields),d={type:"cluster",feature:await r$1(l,r.effectiveFeatureRenderer),cluster:await r$1(l,r.effectiveClusterRenderer)},y=M$1(r.effectiveFeatureRenderer),p={type:"cluster",feature:await l$3(l,c,y),cluster:await l$3(l,{geometryType:"point",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},y)},m=!1;return {storage:t$7(r.effectiveFeatureRenderer,[null,null]),mesh:{properties:{sortKey:null,timeZone:a.timeZone,displayRefreshVersion:u,returnMeshObjectId:m},strategy:{type:"cluster",fields:f,featureFilter:a.filters[0],clusterRadius:u$9(r.clusterRadius/2)},factory:{labels:p,symbology:d}}}}function d$1(e,t,i){const s=null!=t&&"unique-value"===t.type&&t.orderByClassesEnabled;if("default"!==e||s||(e=[new a$7({field:i,order:"descending"})]),"default"!==e&&e.length){e.length;const r=e[0],t="ascending"===r.order?"asc":"desc";return r.field?{field:r.field,order:t}:r.valueExpression?{expression:r.valueExpression,order:t}:null}if(s){return {byRenderer:!0,order:"asc"}}return null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let l$1 = class l{constructor(e){this.layer=e;}getLabelingDeconflictionInfo(e){const r=this.layer,t=l$4(r);return [{vvEvaluators:{0:o$6(r.renderer)},deconflictionEnabled:t}]}async createServiceOptions(o){const s=this.layer,{capabilities:i,editingInfo:a,objectIdField:n,globalIdField:l,datesInUnknownTimezone:p,orderBy:u,parsedUrl:c}=s,d=s.fieldsIndex.toJSON(),m=e$1(s),y=s.timeInfo?.toJSON(),f=s.spatialReference.toJSON(),g$1=a$8(c);let h=n;if(u?.length){const e=!u[0].valueExpression&&u[0].field;e&&(h=e);}return {type:"feature-service",source:g$1,isSourceHosted:g(g$1.path),orderByFields:h,outSpatialReference:o.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:p,globalIdField:l,fieldsIndex:d,geometryType:m,objectIdField:n,timeInfo:y,spatialReference:f,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:a?.lastEditDate?.getTime(),snapshotInfo:null}}}createSourceSchema(e,r){const{definitionExpression:t,customParameters:o,timeExtent:s,apiKey:a}=this.layer;return t$2({definitionExpression:t,customParameters:o,timeExtent:s},e,r,a)}createProcessorSchema(e,r,t){const{fields:o,geometryType:s,orderBy:i,objectIdField:n,renderer:l,labelingInfo:p,labelsVisible:u}=this.layer,c={featureReduction:null,fields:o.map((e=>e.toJSON())),geometryType:s,labelingInfo:p,labelsVisible:u,objectIdField:n,orderBy:i??"default",renderer:l?.clone()};return a$1(e,r,c,t)}get hasRequiredSupport(){return m$6(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const r=this.layer,{definitionExpression:t,apiKey:o,renderer:s}=r,i=this.layer.labelsVisible?this.layer.labelingInfo:null,a=JSON.stringify(r.customParameters),n=JSON.stringify(r.orderBy);return {outFields:this.layer.outFields,apiKey:o,customParameters:a,definitionExpression:t,labelingInfo:i,orderBy:n,renderer:s}}setGraphicOrigin(e){e.origin={type:"catalog",layer:this.layer};}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function t$1(t,e){const n=t.extent,o=e?.clone().intersection(n),i=null!=o?o.width*o.height:0,r=e?e.width*e.height:0,h=0===r?0:i/r,s=has("featurelayer-snapshot-point-coverage");return !isNaN(h)&&h>=s}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function o$2(e,l){return null!=e.floorInfo&&(e.floorInfo.viewAllLevelIds.length>0||l.floors.length>0)}function r(e,o,r){const t=n$2(e,o?.where,r);return t?(o??=new d$6,o.where=t,o):o}function n$2(l,o,r){if(null==l.floorInfo||!r.floors?.length)return o;let n=r.floors;const{floorField:t,viewAllLevelIds:f}=l.floorInfo;f.length&&(n=f);const s=n.filter((e=>""!==e)).map((e=>"'"+e+"'"));if(s.push("''"),o?.includes(t)){let e=new RegExp("AND \\("+t+".*NULL\\)","g");o=o.replace(e,""),e=new RegExp("\\("+t+".*NULL\\)","g"),o=(o=o.replace(e,"")).replaceAll(/\s+/g," ").trim();}let i="("+t+" IN ({ids}) OR "+t+" IS NULL)";return i=i.replace("{ids}",s.join(", ")),n$6(o,i)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let c$1 = class c{constructor(e){this.layer=e;}getLabelingDeconflictionInfo(e){const t=this.layer,r=r$2(t,e)??l$4(t);return [{vvEvaluators:{0:o$6(t.renderer)},deconflictionEnabled:r}]}async createServiceOptions(r){const o=this.layer,{capabilities:i,editingInfo:n,objectIdField:l,typeIdField:p,globalIdField:d,datesInUnknownTimezone:u,orderBy:y,subtypeField:c,refreshInterval:m}=o,f=o.fieldsIndex.toJSON(),h=f.fields,b=e$1(o),g$1=o.timeInfo?.toJSON(),S=o.spatialReference.toJSON(),F=o.types?.map((e=>e.toJSON())),I=a$8(this.layer.parsedUrl);this.layer.dynamicDataSource&&(I.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let x=this.layer.objectIdField;if(y?.length){const e=!y[0].valueExpression&&y[0].field;e&&(x=e);}const j=!(null!=n?.lastEditDate)&&m>0,R=has("featurelayer-snapshot-enabled")&&"point"===o.geometryType&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!j,E=R&&t$1(r,o.fullExtent);return {type:"feature-service",source:I,isSourceHosted:g(I.path),orderByFields:x,outSpatialReference:r.spatialReference.toJSON(),metadata:{typeIdField:p??void 0,types:F,timeReferenceUnknownClient:u,subtypeField:c,globalIdField:d,fields:h,fieldsIndex:f,geometryType:b,objectIdField:l,timeInfo:g$1,spatialReference:S,subtypes:this.layer.subtypes?.map((e=>e.toJSON()))},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:n?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:R,supportsSnapshotMaxThreshold:E,snapshotCountThresholds:{min:has("featurelayer-snapshot-point-min-threshold"),max:has("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:r,customParameters:s,gdbVersion:o,historicMoment:i,subtypeCode:a,subtypeField:n,timeExtent:l,apiKey:p}=this.layer;return t$2({definitionExpression:r,customParameters:s,gdbVersion:o,historicMoment:i,subtypeCode:a,subtypeField:n,timeExtent:l},e,t,p)}createProcessorSchema(e$1,t,s){const{fields:o,renderer:i,geometryType:a,labelingInfo:n,labelsVisible:l,orderBy:p,objectIdField:d}=this.layer,y={fields:o.map((e=>e.toJSON())),renderer:i?.clone(),featureReduction:e(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:l,objectIdField:d,orderBy:p??"default"};return a$1(e$1,t,y,s)}get hasRequiredSupport(){return m$6(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return o$2(this.layer,e)}addFilters(e,t){return r(this.layer,e,t)}getUpdateHashProperties(e$1){const t=this.layer,{definitionExpression:s,renderer:i,gdbVersion:a,apiKey:n,subtypeCode:l}=t,p=this.layer.labelsVisible?this.layer.labelingInfo:null,d=t.historicMoment?.getTime()??void 0,u=JSON.stringify(t.customParameters),y=e(t,e$1),c=JSON.stringify(t.orderBy),m=o$2(this.layer,e$1)?e$1.floors:null;return {outFields:this.layer.outFields,apiKey:n,customParameters:u,definitionExpression:s,featureReduction:y,floors:m,gdbVersion:a,historicMoment:d,labelingInfo:p,orderBy:c,renderer:i,subtypeCode:l}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function u$2(r){if(!("openPorts"in r))throw new s$4("source-not-supported")}class p{constructor(e){this.layer=e;}getLabelingDeconflictionInfo(e){const r=this.layer,t=r$2(r,e)??l$4(r);return [{vvEvaluators:{0:o$6(r.renderer)},deconflictionEnabled:t}]}async createServiceOptions(e){const r=this.layer,{capabilities:o,objectIdField:s}=r,i=r.fieldsIndex.toJSON(),n=e$1(r),l=r.timeInfo?.toJSON(),a=r.spatialReference.toJSON();u$2(r.source);return {type:"memory",source:await r.source.openPorts(),orderByFields:s,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:i,geometryType:n,objectIdField:s,timeInfo:l,spatialReference:a,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:null},queryMetadata:{maxRecordCount:o.query.maxRecordCount,supportsCompactGeometry:o.query.supportsCompactGeometry,supportsDefaultSpatialReference:o.query.supportsDefaultSpatialReference,supportsFormatPBF:o.query.supportsFormatPBF,supportsMaxRecordCountFactor:o.query.supportsMaxRecordCountFactor,supportsQuantization:o.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,r){const{definitionExpression:t,timeExtent:o}=this.layer;return t$2({definitionExpression:t,timeExtent:o,customParameters:null},e,r,null)}createProcessorSchema(e$1,t,o){const{fields:s,renderer:i,geometryType:n,labelingInfo:a,labelsVisible:u,orderBy:p,objectIdField:c}=this.layer,d={fields:s.map((e=>e.toJSON())),renderer:i?.clone(),featureReduction:e(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:u,objectIdField:c,orderBy:p??"default"};return a$1(e$1,t,d,o)}get hasRequiredSupport(){return m$6(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e$1){const t=this.layer,{definitionExpression:o,renderer:s}=t,i=this.layer.labelsVisible?this.layer.labelingInfo:null,n=e(t,e$1);return {orderBy:JSON.stringify(t.orderBy),definitionExpression:o,renderer:s,labelingInfo:i,featureReduction:n}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
class a{constructor(e){this.layer=e,this.timeOptions=null;}getLabelingDeconflictionInfo(e){const r=this.layer,i=r$2(r,e)??l$4(r);return [{vvEvaluators:{0:o$6(r.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:o,objectIdField:s}=t,i=t.fieldsIndex.toJSON(),l=e$1(t),n=t.spatialReference.toJSON();return {type:"memory",source:await t.source.openPorts(),orderByFields:s,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:i,geometryType:l,objectIdField:s,spatialReference:n,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:o.query.maxRecordCount,supportsCompactGeometry:o.query.supportsCompactGeometry,supportsDefaultSpatialReference:o.query.supportsDefaultSpatialReference,supportsFormatPBF:o.query.supportsFormatPBF,supportsMaxRecordCountFactor:o.query.supportsMaxRecordCountFactor,supportsQuantization:o.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,r){const{definitionExpression:t}=this.layer;return t$2({definitionExpression:t,customParameters:null},e,r,null)}createProcessorSchema(r,t,o){const{fields:s,renderer:i,geometryType:n,labelingInfo:a,labelsVisible:u,objectIdField:p}=this.layer,c={fields:s.map((e=>e.toJSON())),renderer:i?.clone(),featureReduction:e(this.layer,t),geometryType:n,labelingInfo:a,labelsVisible:u,objectIdField:p,orderBy:"default"};return a$1(r,t,c,o)}get hasRequiredSupport(){return m$6(this.layer.renderer)}getUpdateHashProperties(r){const t=this.layer,{definitionExpression:o,renderer:s}=t;return {definitionExpression:o,renderer:s,labelingInfo:this.layer.labelsVisible?this.layer.labelingInfo:null,featureReduction:e(t,r)}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let u$1 = class u{constructor(e){this.layer=e;}getLabelingDeconflictionInfo(e){const r=this.layer,t=r$2(r,e)??l$4(r);return [{vvEvaluators:{0:o$6(r.renderer)},deconflictionEnabled:t}]}async createServiceOptions(r){const o=this.layer,{capabilities:s,objectIdField:a}=o,i=o.fieldsIndex.toJSON(),l=e$1(o),n=o.timeInfo?.toJSON(),u=o.spatialReference.toJSON(),c=o.source.getSource(),p=this.layer.objectIdField,d=a$8(s);return d.query.maxRecordCount=c.maxRecordCount,{type:"ogc",source:c,orderByFields:p,outSpatialReference:r.spatialReference.toJSON(),metadata:{fieldsIndex:i,geometryType:l,objectIdField:a,timeInfo:n,spatialReference:u,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:d.query.maxRecordCount,supportsCompactGeometry:d.query.supportsCompactGeometry,supportsDefaultSpatialReference:d.query.supportsDefaultSpatialReference,supportsFormatPBF:d.query.supportsFormatPBF,supportsMaxRecordCountFactor:d.query.supportsMaxRecordCountFactor,supportsQuantization:d.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,r){const{customParameters:t,timeExtent:o,apiKey:s}=this.layer;return t$2({customParameters:t,timeExtent:o},e,r,s)}createProcessorSchema(e$1,t,o){const{fields:s,renderer:a,geometryType:i,labelingInfo:n,labelsVisible:u,orderBy:c,objectIdField:p}=this.layer,d={fields:s.map((e=>e.toJSON())),renderer:a?.clone(),featureReduction:e(this.layer,t),geometryType:i,labelingInfo:n,labelsVisible:u,objectIdField:p,orderBy:c??"default"};return a$1(e$1,t,d,o)}get hasRequiredSupport(){return m$6(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e$1){const t=this.layer,{renderer:o,apiKey:s}=t,a=this.layer.labelsVisible?this.layer.labelingInfo:null;return {apiKey:s,customParameters:JSON.stringify(t.customParameters),featureReduction:e(t,e$1),labelingInfo:a,orderBy:JSON.stringify(t.orderBy),renderer:o}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
let m$1 = class m{constructor(e){this.layer=e;}getLabelingDeconflictionInfo(e){const r=this.layer,t=r$2(r,e)??l$4(r);return [{vvEvaluators:{0:o$6(r.renderer)},deconflictionEnabled:t}]}async createServiceOptions(t){const s=this.layer,{capabilities:i,objectIdField:l,globalIdField:n,orderBy:p,refreshInterval:u}=s,d=s.fieldsIndex.toJSON(),c=d.fields,m=e$1(s),f=s.timeInfo?.toJSON(),y=s.spatialReference.toJSON(),h=a$8(this.layer.parsedUrl);let b=this.layer.objectIdField;if(p?.length){const e=!p[0].valueExpression&&p[0].field;e&&(b=e);}const g$1=u>0,S=has("featurelayer-snapshot-enabled")&&"point"===s.geometryType&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!g$1,F=S&&t$1(t,s.fullExtent);return {type:"feature-service",source:h,isSourceHosted:g(h.path),orderByFields:b,outSpatialReference:t.spatialReference.toJSON(),metadata:{globalIdField:n,fields:c,fieldsIndex:d,geometryType:m,objectIdField:l,timeInfo:f,spatialReference:y,timeReferenceUnknownClient:!1,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:null,snapshotInfo:{supportsSnapshotMinThreshold:S,supportsSnapshotMaxThreshold:F,snapshotCountThresholds:{min:has("featurelayer-snapshot-point-min-threshold"),max:has("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,r){const{definitionExpression:t,customParameters:o,timeExtent:s}=this.layer;return t$2({definitionExpression:t,customParameters:o,timeExtent:s},e,r,null)}createProcessorSchema(e$1,r,o){const{fields:s,renderer:i,geometryType:a,labelingInfo:l,labelsVisible:n,orderBy:p,objectIdField:u}=this.layer,c={fields:s.map((e=>e.toJSON())),renderer:i?.clone(),featureReduction:e(this.layer,r),geometryType:a,labelingInfo:l,labelsVisible:n,objectIdField:u,orderBy:p??"default"};return a$1(e$1,r,c,o)}get hasRequiredSupport(){return m$6(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return o$2(this.layer,e)}addFilters(e,r$1){return r(this.layer,e,r$1)}getUpdateHashProperties(e$1){const r=this.layer,{definitionExpression:o,renderer:i,outFields:a}=r,l=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(r.customParameters),p=e(r,e$1);return {outFields:a,orderBy:JSON.stringify(r.orderBy),definitionExpression:o,renderer:i,labelingInfo:l,featureReduction:p,customParameters:n,floors:o$2(this.layer,e$1)?e$1.floors:null}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
class l{constructor(e){this.layer=e;}getLabelingDeconflictionInfo(e){const t=this.layer,o=r$2(t,e)??l$4(t);return [{vvEvaluators:{0:o$6(t.renderer)},deconflictionEnabled:o}]}async createServiceOptions(e){const r=this.layer,{objectIdField:i}=r,n=e$1(r),o=r.timeInfo?.toJSON()||null,s=r.spatialReference?r.spatialReference.toJSON():null;return {type:"stream",source:this.layer.parsedUrl,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:n,objectIdField:i,timeInfo:o,timeReferenceUnknownClient:null,spatialReference:s,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}}createSourceSchema(e,t){const{definitionExpression:r,geometryDefinition:i,customParameters:n}=this.layer;return {type:"stream",mutable:{sourceRefreshVersion:t,availableFields:e.availableFields,dataFilter:{geometryDefinition:i?.toJSON(),definitionExpression:r,customParameters:n??null,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(t,r,i){const{fields:n,renderer:s,geometryType:l,labelingInfo:a,labelsVisible:c,objectIdField:d}=this.layer,m={fields:n.map((e=>e.toJSON())),renderer:s?.clone(),featureReduction:e(this.layer,r),geometryType:l,labelingInfo:a,labelsVisible:c,objectIdField:d,orderBy:"default"};return a$1(t,r,m,i)}get hasRequiredSupport(){return m$6(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(t){const r=this.layer,{definitionExpression:i,renderer:n}=r,o=this.layer.labelsVisible?this.layer.labelingInfo:null,s=JSON.stringify(r.customParameters);return {definitionExpression:i,renderer:n,labelingInfo:o,featureReduction:e(r,t),customParameters:s,geometryDefinition:r.geometryDefinition,definitionExpressoin:r.definitionExpression}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
async function i$1(e,{subtypeField:t,sublayers:s}){const a=await Promise.all(s.map((({renderer:t})=>r$1(e,t))));return {type:"subtype",subtypeField:t,renderers:s.reduce(((e,{subtypeCode:r},t)=>({...e,[r]:a[t]})),{})}}function o$1(e,r){const s=t$8();return {type:"subtype",filters:e.filters,capabilities:{maxTextureSize:s.maxTextureSize},subtypeField:r.subtypeField,target:"feature",bindings:r.sublayers.reduce(((e,{renderer:r,subtypeCode:s})=>{const a=c$7(r);return {...e,[s]:a}}),{})}}async function u(r,{subtypeField:t,sublayers:a}){const i=await Promise.all(a.map((t=>{const a=M$1(t.renderer),i={...t,geometryType:t.geometryType??null};return l$3(r,i,a)})));return {type:"subtype",subtypeField:t,renderers:a.reduce(((e,{subtypeCode:r},t)=>({...e,[r]:i[t]})),{})}}async function n$1(e,r,t,s){return {storage:o$1(r,t),mesh:{properties:{timeZone:r.timeZone,displayRefreshVersion:s,returnMeshObjectId:!1,sortKey:null},strategy:{type:"feature"},factory:{symbology:await i$1(e,t),labels:await u(e,t)}}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
class m{constructor(e){this.layer=e;}getLabelingDeconflictionInfo(e){return [{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every((e=>l$4(e)))}]}async createServiceOptions(t){const r=this.layer,{capabilities:i,datesInUnknownTimezone:a,editingInfo:l,globalIdField:p,objectIdField:u,refreshInterval:y,subtypeField:m}=r,c=r.fieldsIndex.toJSON(),d=e$1(r),h=r.timeInfo?.toJSON(),f=r.spatialReference.toJSON(),b=a$8(this.layer.parsedUrl),g$1=u,S=!(null!=l?.lastEditDate)&&y>0,F=has("featurelayer-snapshot-enabled")&&"point"===r.geometryType&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!S,x=F&&t$1(t,r.fullExtent);return {type:"feature-service",source:b,isSourceHosted:g(b.path),orderByFields:g$1,outSpatialReference:t.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:a,subtypeField:m,globalIdField:p,fieldsIndex:c,geometryType:d,objectIdField:u,timeInfo:h,spatialReference:f,subtypes:this.layer.subtypes?.map((e=>e.toJSON())),typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:l?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:F,supportsSnapshotMaxThreshold:x,snapshotCountThresholds:{min:has("featurelayer-snapshot-point-min-threshold"),max:has("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:r,customParameters:s,gdbVersion:i,historicMoment:o,subtypeField:a,timeExtent:l,apiKey:n}=this.layer,p={queryScaleRanges:this.layer.sublayers.items.map((e=>({subtypeCode:e.subtypeCode,minScale:e.minScale,maxScale:e.maxScale}))),definitionExpression:r,customParameters:s,gdbVersion:i,historicMoment:o,subtypeField:a,timeExtent:l};return t$2(p,e,t,n)}createProcessorSchema(e,t,r){const s={subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,(e=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible,renderer:e.renderer,subtypeCode:e.subtypeCode,orderBy:null})))};return n$1(e,t,s,r)}hasFilters(e){return o$2(this.layer,e)||c(this.layer,e)}addFilters(e,t){e=r(this.layer,e,t);const s=this.layer.sublayers.filter((e=>!d(e,t))).map((e=>e.subtypeCode));if(!s.length)return e;e??=new d$6;const o=`NOT ${this.layer.subtypeField} IN (${s.join(",")})`;return e.where=n$6(e.where,o),e}get hasRequiredSupport(){return !0}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:r,gdbVersion:s,apiKey:i}=t,o=t.historicMoment?.getTime()??void 0,l=JSON.stringify(t.customParameters),n=o$2(this.layer,e)?e.floors:null,p=this.layer.sublayers.map((({renderer:e,labelsVisible:t,labelingInfo:r,visible:s})=>({renderer:e,labelsVisible:t,labelingInfo:r,visible:s})));return {outFields:this.layer.outFields,gdbVersion:s,definitionExpression:r,historicMoment:o,customParameters:l,apiKey:i,sublayers:p,floors:n}}setGraphicOrigin(e){const t=this.layer.fieldsIndex.get(this.layer.subtypeField),r=e.attributes[t.name],s=this.layer.sublayers.find((e=>e.subtypeCode===r));e.layer=e.sourceLayer=s;}}function c(e,t){return e.sublayers.some((e=>!d(e,t)))}function d(e,r){return e.visible&&(0===e.minScale||F$1(r.scale,e.minScale)||r.scale<e.minScale)&&(0===e.maxScale||F$1(r.scale,e.maxScale)||r.scale>e.maxScale)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
async function n(n,r){try{return await n}catch(t){if("no-queryEngine"!==t.name)throw t;return r}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function s(e,s){const t=new Set;for(const i of e instanceof Set?e.values():e.keys())s.has(i)||t.add(i);return t}class t{constructor(e,s,t){const i=t?e.getTileCoverage(t,0,!0,"closest"):null,o=e.getTileCoverage(s,0,!0,"closest");if(this._tileKeys=new Map,i)for(const n of i.keys())this._tileKeys.set(n.id,n);if(o)for(const n of o.keys())this._tileKeys.set(n.id,n);}get coverageSet(){return new Set(this._tileKeys.keys())}keys(){return this._tileKeys.values()}}class i{constructor(e){this.version=e;}}class o{constructor(e){this._subscriptions=new Map,this._visible=new Set,this._paused=new Set,this._version=0,this._config=e;}destroy(){}get _coverageSet(){return this._coverage?.coverageSet??new Set}suspend(){this._suspendedOverage=this._coverage,this._coverage=null,this._updateSubscriptions();}resume(){null==this._coverage&&(this._coverage=this._suspendedOverage,this._suspendedOverage=null,this._updateSubscriptions());}update(e,s){return this._version=(this._version+1)%Number.MAX_SAFE_INTEGER,this._updateCoverage(e,s),this._updateSubscriptions(),new Set(this._visible)}_updateCoverage(e,s){this._coverage=new t(this._config.tileInfoView,e,s);}_updateSubscriptions(){const e=this._coverageSet,t=this._updateVisibility(),o=s(t,e),n=s(this._subscriptions,t),r=s(e,this._subscriptions),a=s(n,e),c=s(o,a),u=s(c,this._paused);this._visible=t;for(const s of r.values())this._subscriptions.set(s,new i(this._version));for(const s of u.values())this._paused.add(s);for(const s of a.values())this._subscriptions.delete(s),this._paused.delete(s);(r.size||a.size||u.size)&&this._sendUpdateSubscriptions(r,a,u);}_sendUpdateSubscriptions(e,s,t){const i=Array.from(e.values()).map((e=>({tileId:e,version:this._subscriptions.get(e).version})));this._config.updateSubscriptions({subscribe:i,unsubscribe:Array.from(s.values()),pause:Array.from(t.values())});}_updateVisibility(){const s=new Set,t=new Set;if(!this._coverage)return s;for(const e of this._coverage.keys()){if(this._config.isDone(e)){s.add(e.id);continue}if(this._addVisibleParent(s,t,e))continue;this._addVisibleChildren(s,e)||s.add(e.id);}const i=new e$3(0,0,0,0),o=new e$3(0,0,0,0);for(const e of t){i.id=e;for(const e of s)o.id=e,i.containsChild(o)&&s.delete(e);}return s}_addVisibleParent(s,t,i){let o=!1;for(const n of this._visible.values()){new e$3(n).containsChild(i)&&(s.add(n),t.add(n),o=!0);}return o}_addVisibleChildren(s,t){let i=!1;for(const o of this._visible.values()){const n=new e$3(o);t.containsChild(n)&&(s.add(o),i=!0);}return i}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
const _=_=>{let q=class extends _{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.layer=null,this.requiredFields=[],this.view=null;}initialize(){this.addHandles([d$7((()=>{const e=this.layer;return [e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]}),(()=>this._handleRequiredFieldsChange()),A$1),v((()=>this.view?.floors),"change",(()=>this._handleRequiredFieldsChange())),v((()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null}),"change",(()=>this._handleRequiredFieldsChange()))]);}get availableFields(){if(!this.layer)return [];const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return "outFields"in e&&e.outFields?I$1(t,[...x$2(t,e.outFields),...r]):I$1(t,r)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e);}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){n$5.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported");}get maximumNumberOfFeaturesExceeded(){return !1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new b$1(e);if("floorInfo"in this.layer&&this.layer.floorInfo){const e=o$d(this);null!=e&&(t.where=t.where?`(${t.where}) AND (${e})`:e);}return null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new b$1(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){return this._validateFetchPopupFeatures(e,t),this._fetchPopupFeatures(e,t)}_loadArcadeModules(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?i$7():Promise.resolve()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null);}));}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:i,objectIdField:o}}=this,s="renderer"in t&&t.renderer,n="orderBy"in t&&t.orderBy,l="featureReduction"in t?t.featureReduction:null,a=new Set,u=await Promise.allSettled([s?s.collectRequiredFields(a,i):null,J(a,t),e&&"elevationInfo"in t?v$1(a,t):null,null!=this.filter?M$2(a,t,this.filter):null,e||null==this.featureEffect?null:M$2(a,t,this.featureEffect.filter),!e&&l?L$2(a,t,l):null,!e&&n?O$1(a,t,n):null]);if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&b$2(a,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"floorInfo"in t&&t.floorInfo&&b$2(a,t.fieldsIndex,[t.floorInfo.floorField]),"feature"===t.type&&e&&null!=t.infoFor3D&&(null==t.globalIdField&&n$5.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),b$2(a,t.fieldsIndex,[t.globalIdField])),"subtype-group"===t.type){w$2(a,i,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(a,i),J(a,e)])));await Promise.allSettled(e);}if("catalog-footprint"===t.type&&t.parent){const e=t.parent;b$2(a,i,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField]);}for(const d of u)"rejected"===d.status&&n$5.getLogger(this).error(d.reason);w$2(a,i,o),e&&"displayField"in t&&t.displayField&&w$2(a,i,t.displayField);const p=Array.from(a).sort();this._set("requiredFields",p);}_validateFetchPopupFeatures(e,r){if(null!=r)for(const i of e){const e=i.origin&&"layer"in i.origin?i.origin.layer:i.layer;if("popupEnabled"in e&&!e.popupEnabled)throw new s$4("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:e});if(i.isAggregate){const r="featureReduction"in e?e.featureReduction:null;if(!(r&&"popupTemplate"in r&&r.popupEnabled&&r.popupTemplate))throw new s$4("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:e})}else if("popupTemplate"in e){if(!p$5(e,r))throw new s$4("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:e})}}}_popupFeatureHasRequiredFields(e,t){return je(t,e)}async _fetchPopupFeatures(e,t){const r=new Array(e.length),o=new Map,s=await this._createPopupQuery(e.map((e=>e.origin?.layer??e.layer)),t);for(let n=0;n<e.length;n++){const l=e[n];if(l.isAggregate){r[n]=l;continue}const a=l.origin?.layer??l.layer;if(!a||!("popupEnabled"in a))continue;const u=x$2(this.layer.fieldsIndex,s.outFields),p=p$5(a,t);if(null==p)continue;const d=await this._loadArcadeModules(p);s$5(t);d&&d.arcadeUtils.hasGeometryOperations(p)||!this._popupFeatureHasRequiredFields(l,u)?o.set(l.getObjectId(),{graphic:l,index:n}):r[n]=l;}if("stream"===this.layer.type||0===o.size)return r.filter(Boolean);s.objectIds=Array.from(o.keys());try{const e=await this.layer.queryFeatures(s,t);for(const t of e.features){const{graphic:{geometry:e,origin:i},index:s}=o.get(t.getObjectId());t.geometry||=e,t.origin=i,r[s]=t;}}catch{}return r.filter(Boolean)}async _createPopupQuery(e,t){const r=this.layer.createQuery(),o=new Set;let s=!1;const n=e??[this.layer];for(const l of n){if(!("popupEnabled"in l))continue;const e=p$5(l,t);if(null==e)continue;const r=await this._loadArcadeModules(e);s$5(t);const n=r&&r.arcadeUtils.hasGeometryOperations(e);s=!("point"!==this.layer.geometryType&&!n);const a=await n$8(this.layer,e);s$5(t);for(const t of a)o.add(t);}if(r.returnGeometry=s,r.returnZ=s,r.returnM=s,r.outFields=Array.from(o),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){const e=o$d(this);null!=e&&(r.where=r.where?`(${r.where}) AND (${e})`:e);}return r}canResume(){return !!super.canResume()&&(null==this.timeExtent||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return e$2([y$1()],q.prototype,"_updatingRequiredFieldsPromise",void 0),e$2([y$1({readOnly:!0})],q.prototype,"availableFields",null),e$2([y$1({readOnly:!0})],q.prototype,"dataUpdating",void 0),e$2([y$1({type:w$1})],q.prototype,"featureEffect",null),e$2([y$1({type:d$6})],q.prototype,"filter",void 0),e$2([y$1()],q.prototype,"layer",void 0),e$2([y$1({type:Number})],q.prototype,"maximumNumberOfFeatures",null),e$2([y$1({readOnly:!0,type:Boolean})],q.prototype,"maximumNumberOfFeaturesExceeded",null),e$2([y$1({readOnly:!0})],q.prototype,"requiredFields",void 0),e$2([y$1()],q.prototype,"suspended",void 0),e$2([y$1()],q.prototype,"view",void 0),q=e$2([a$3("esri.views.layers.FeatureLayerView")],q),q};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.30/esri/copyright.txt for details.
*/
function X(e,t){const r=new Set;return e&&e.forEach((e=>r.add(e))),t&&t.forEach((e=>r.add(e))),r.has("*")?["*"]:Array.from(r)}const Y=4294967294;let ee=class extends(_(i$8(f$4(y$3)))){constructor(){super(...arguments),this._commandsQueue=new t$9({process:e=>{switch(e.type){case"edit-by-feature":case"edit-by-id":return this._doEdit(e);case"update":return this._doUpdate();case"highlight":return this._updateHighlights()}}}),this._visibilityOverrides=new Set,this._highlightCounter=new e$5,this._lastAvailableFields=[],this._lastTargetState=null,this.eventLog=new l$6,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._fields=null,this.featureEffectView=new r$4;}destroy(){this._workerProxy?.destroy(),this._workerAttached.reject(u$a()),this._commandsQueue.destroy();}initialize(){this._workerAttached=L$1(),d$8(this._workerAttached.promise),this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransitions();}async _initProxy(){const e=this.layer;if("isTable"in e&&e.isTable)throw new s$4("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e});if("mesh"===e.geometryType)throw new s$4("featurelayerview:geometry-type-not-supported",`Geometry type of ${e.geometryType} is not supported`,{layer:e});if(("feature"===e.type||"subtype-group"===e.type)&&!1===O$2(e)?.operations.supportsQuery)throw new s$4("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});this._workerProxy&&this._workerProxy.destroy();const t=this._createClientOptions();this._workerProxy=await t$4(t);}async _attachProxy(){const e={service:await this.layerAdapter.createServiceOptions(this.view),tileInfoJSON:this.view.featuresTilingScheme.tileInfo.toJSON()};let t=[];Array.isArray(e.service.source)&&(t=e.service.source);try{await this._workerProxy.pipeline.onAttach(e,{transferList:t}),this._workerAttached.resolve();}catch(r){this._workerAttached.reject(u$a()),f$5(r);}}async _detachProxy(){return this._workerProxy.pipeline.onDetach()}async getWorker(){return await this._workerAttached.promise,this._workerProxy}get hasAllFeatures(){return this.layer.visible&&this.eventLog.hasAllFeatures}get hasAllFeaturesInView(){return this.layer.visible&&this.eventLog.hasAllFeaturesInView}get hasFullGeometries(){return this.layer.visible&&this.eventLog.hasFullGeometries}get labelingCollisionInfos(){const e=this.layerAdapter.getLabelingDeconflictionInfo(this.view),t=this.layer.geometryType,r=!this.suspended;return e.map((({vvEvaluators:e,deconflictionEnabled:i})=>({container:this.featureContainer,vvEvaluators:e,deconflictionEnabled:i,geometryType:t,visible:r})))}get layerAdapter(){switch(this.layer.type){case"feature":return "memory"===this.layer.source.type?new p(this.layer):new c$1(this.layer);case"geojson":case"csv":case"wfs":return new p(this.layer);case"subtype-group":return new m(this.layer);case"ogc-feature":return new u$1(this.layer);case"stream":return new l(this.layer);case"oriented-imagery":return new m$1(this.layer);case"knowledge-graph-sublayer":return new a(this.layer);case"catalog-footprint":return new l$1(this.layer);default:n$9(this.layer);}return null}get timeExtent(){return i$9(this.layerAdapter.timeOptions,this.view?.timeExtent,this._get("timeExtent"))}getDisplayStatistics(e,t){return this.featureContainer?.getDisplayStatistics(e,t)}async queryHeatmapStatistics(e){return (await this.getWorker()).pipeline.queryHeatmapStatistics(e)}highlight(e,t="highlight"){let a;e instanceof d$3?a=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?a=[e]:V.isCollection(e)&&e.length>0?a=e.map((e=>e?.getObjectId())).toArray():Array.isArray(e)&&e.length>0&&(a="number"==typeof e[0]||"string"==typeof e[0]?e:e.map((e=>e?.getObjectId())));const o=a?.filter(O$3);return o?.length?(this._addHighlights(o,t),e$6((()=>this._removeHighlights(o,t)))):e$6()}getHighlightIds(){return Array.from(this._highlightCounter.ids())}hasHighlight(){return !this._highlightCounter.empty}async hitTest(e,i){const s=await this.featureContainer.hitTest(i);if(0===s.length)return null;const a=await this.getWorker(),{features:o,aggregates:n}=await a.pipeline.getDisplayFeatures(s),u=this.featureContainer.getSortKeys(s),l=({displayId:e},{displayId:t})=>u.has(e)&&u.has(t)?u.get(e)-u.get(t):e-t;return o.sort(l).reverse(),n.sort(l).reverse(),[...n.map((r=>this._createGraphicHit(e,s$3.fromJSON(r)))),...o.map((t=>this._createGraphicHit(e,d$3.fromJSON(t))))]}async queryStatistics(){const e=await this.getWorker();return n(e.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})}async querySummaryStatistics(e,t,r){const i=await this.getWorker(),s={...t,scale:this.view.scale},a=i.features.executeQueryForSummaryStatistics(this._cleanUpQuery(e),s,r);return n(a,{})}async queryAggregateSummaryStatistics(e,t,r){const i={...t,scale:this.view.scale},s=(await this.getWorker()).aggregates.executeQueryForSummaryStatistics(this._cleanUpAggregateQuery(e),i,r);return n(s,{})}async queryUniqueValues(e,t,r){const i=await this.getWorker(),s={...t,scale:this.view.scale},a=i.features.executeQueryForUniqueValues(this._cleanUpQuery(e),s,r);return n(a,{uniqueValueInfos:[]})}async queryAggregateUniqueValues(e,t,r){const i=await this.getWorker(),s={...t,scale:this.view.scale},a=i.aggregates.executeQueryForUniqueValues(this._cleanUpAggregateQuery(e),s,r);return n(a,{uniqueValueInfos:[]})}async queryClassBreaks(e,t,r){const i=await this.getWorker(),s={...t,scale:this.view.scale},a=i.features.executeQueryForClassBreaks(this._cleanUpQuery(e),s,r);return n(a,{classBreakInfos:[]})}async queryAggregateClassBreaks(e,t,r){const i=await this.getWorker(),s={...t,scale:this.view.scale},a=i.aggregates.executeQueryForClassBreaks(this._cleanUpAggregateQuery(e),s,r);return n(a,{classBreakInfos:[]})}async queryHistogram(e,t,r){const i=await this.getWorker(),s={...t,scale:this.view.scale},a=i.features.executeQueryForHistogram(this._cleanUpQuery(e),s,r);return n(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}async queryAggregateHistogram(e,t,r){const i=await this.getWorker(),s={...t,scale:this.view.scale},a=i.aggregates.executeQueryForHistogram(this._cleanUpAggregateQuery(e),s,r);return n(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then((e=>{const t=d$4.fromJSON(e);return t.features.forEach((e=>this._setLayersForFeature(e))),t}))}async queryVisibleFeatures(e,t){const r=(await this.getWorker()).pipeline.queryVisibleFeatures(this._cleanUpQuery(e),t),i=await n(r,{features:[]}),s=d$4.fromJSON(i);return s.features.forEach((e=>this._setLayersForFeature(e))),s}async queryAggregates(e,t){const r=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t),i=await n(r,{features:[]}),s=m$4.fromJSON(i);return s.features.forEach((e=>this._setLayersForFeature(e))),s}async queryAggregateIds(e,t){const r=(await this.getWorker()).aggregates.executeQueryForIds(this._cleanUpAggregateQuery(e),t);return n(r,[])}async queryAggregateCount(e,t){const r=(await this.getWorker()).aggregates.executeQueryForCount(this._cleanUpAggregateQuery(e),t);return n(r,0)}async queryAggregateJSON(e,t){const r=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t);return n(r,{features:[]})}async queryFeaturesJSON(e,t){const r=(await this.getWorker()).features.executeQuery(this._cleanUpQuery(e),t);return n(r,{features:[]})}async queryObjectIds(e,t){const r=(await this.getWorker()).features.executeQueryForIds(this._cleanUpQuery(e),t);return n(r,[])}async queryFeatureCount(e,t){const r=(await this.getWorker()).features.executeQueryForCount(this._cleanUpQuery(e),t);return n(r,0)}async queryExtent(e,t){const r=(await this.getWorker()).features.executeQueryForExtent(this._cleanUpQuery(e),t),i=await n(r,{count:0,extent:null});return {count:i.count,extent:w$3.fromJSON(i.extent)}}async getSampleFeatures(e){return (await this.getWorker()).pipeline.getSampleFeatures(e)}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update();}update(e){if(!this._subscriptionManager)return;this.view.animation&&!this._lastTargetState&&(this._lastTargetState=e.state.clone()),!this.view.animation&&this._lastTargetState&&(this._lastTargetState=null);const t=this._subscriptionManager.update(e.targetState,this._lastTargetState);this.featureContainer.setVisibleTiles(t);}attach(){has("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.attach"),d$8(this._updatingHandles.addPromise(this._workerAttached.promise)),d$8(this._attachProxy()),this.featureContainer=new u$7(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._subscriptionManager=new o({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:e=>{this.featureContainer.updateSubscriptions(e),d$8(this._updatingHandles.addPromise(this.getWorker().then((t=>t.pipeline.updateSubscriptions(e)))));},isDone:e=>this.featureContainer.isDone(e)}),this.requestUpdate(),this.addAttachHandles([d$7((()=>JSON.stringify({displayRefreshVersion:this._displayRefreshVersion,timeExtent:this.timeExtent,clips:this.clips,filter:this.filter,featureEffect:this.featureEffect,sourceRefreshVersion:this._sourceRefreshVersion,timeZone:this.view.timeZone,effect:this.featureEffect,...this.layerAdapter.getUpdateHashProperties(this.view)})),(()=>this._update()),P$1),d$7((()=>this.updateSuspended),(e=>{e||(this._subscriptionManager.resume(),this.view.labelManager.requestUpdate());}))]),"stream"!==this.layer.type&&"catalog-footprint"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",(e=>this._edit(e))));}detach(){has("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.detach"),this._detachProxy(),this._fields=null,this.featureContainer.destroy(),this.featureContainer=null,this._commandsQueue.clear(),this.container.removeAllChildren(),this._subscriptionManager=u$b(this._subscriptionManager),this._workerProxy.pipeline.onDetach(),this._workerAttached=L$1(),d$8(this._workerAttached.promise),this._lastAvailableFields=[],this._lastSchema=null;}viewChange(){this.requestUpdate();}moveEnd(){this.requestUpdate();}isUpdating(){const e="renderer"in this.layer&&null!=this.layer.renderer,t=this._commandsQueue.updateTracking.updating,r=null!=this._updatingRequiredFieldsPromise,i=this.featureContainer.updatingHandles.updating,s=this.updateRequested||e&&(t||r)||i||this._pipelineUpdating||this.dataUpdating;if(has("esri-2d-log-updating")){console.log(`Updating FLV2D (${this.layer.id}): ${s}\n  -> updateRequested ${this.updateRequested}\n  -> hasRenderer ${e}\n  -> updatingRequiredFields ${r}\n  -> hasPendingCommand ${t}\n  -> dataUpdating ${this.dataUpdating}\n  -> processing ${this._pipelineUpdating}\n  -> updatingContainer ${i}\n`);for(const e of this.featureContainer.subscriptions())console.log(`    -> Tile[${e.id}] Done: ${e.done}`);}return s}_createClientOptions(){const e=this;return {get container(){return e.featureContainer},setUpdating:e=>{this._set("_pipelineUpdating",e.pipeline),this._set("dataUpdating",e.data);},emitEvent:e=>{this.emit(e.name,e.event);},get eventLog(){return e.eventLog},fetch:t=>Promise.all(t.map((t=>e.view.stage.painter.textureManager.rasterizeItem(t)))),fetchDictionary:e=>Promise.all(e.map((e=>this._fetchDictionaryRequest(e))))}}async _fetchDictionaryRequest(e){try{if("subtype-group"===this.layer.type)throw new Error("InternalError: SubtypeGroupLayer does not support dictionary renderer");const t=this.layer.renderer;if(!t||"dictionary"!==t.type)throw new Error("InternalError: Expected layer to have a DictionaryRenderer");const r=this._lastSchema.processor.mesh.factory.symbology;if("dictionary"!==r.type)throw new Error("InternalError: Expected schema to be of type 'dictionary'");const i={cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,store:this.featureContainer.instanceStore,scaleExpression:r.scaleExpression};this._fields||(this._fields=this.layer.fields.map((e=>e.toJSON())));const s=r.visualVariableUniforms,a=await t.getSymbolAsync(e.feature,{fields:this._fields});if(!a||!a.data)return {type:"dictionary-response",meshes:[]};return {type:"dictionary-response",meshes:await n$7(a.data,{uniforms:s,path:"renderer",schemaOptions:i})}}catch(t){return {type:"dictionary-response",meshes:[]}}}_cleanUpQuery(e){const t=b$1.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t.toJSON()}_cleanUpAggregateQuery(e){const t=b$1.from(e)||this.createAggregateQuery();t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference);const r=t.objectIds??[];for(const i of t.aggregateIds??[])r.push(i);return t.objectIds=r,t.aggregateIds=[],t.toJSON()}async _update(){return this._commandsQueue.push({type:"update"})}async _edit(e){if(this.updateSuspended)return void this._subscriptionManager.suspend();const t=this._getEffectiveEdit(e);return t?this._commandsQueue.push(t).catch(f$5):void 0}async doRefresh(e){this.attached&&(this.updateSuspended&&e||(e?this.incrementSourceRefreshVersion():this.incrementDisplayRefreshVersion()));}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%Y+1;}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%Y+1;}_getEffectiveEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,r=e.deletedFeatures.some((e=>-1===e.objectId||!e.objectId)),i=t&&this.availableFields.includes(t);if(r&&!i)return n$5.getLogger(this).error(new s$4("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null;const s=this.layer,a=e.historicMoment?.getTime()??null,n="layerId"in s&&e.editedFeatures?.find((e=>e.layerId===s.layerId));if(n&&this._canEditByFeature(n)){const e=!1,r=!1,i=s$7(this.layer.geometryType),{adds:s,deletes:o,updates:u}=n.editedFeatures,l=this.layer.objectIdField,h=s.map((t=>tt(t,i,e,r))),c=u.map((t=>tt(t.current,i,e,r)));return {type:"edit-by-feature",added:h,removed:o.map((e=>"attributes"in e?{globalId:t?e.attributes[t]:null,objectId:l?e.attributes[l]:null}:e)),updated:c,historicMoment:a}}return {type:"edit-by-id",added:e.addedFeatures,updated:e.updatedFeatures,removed:e.deletedFeatures,historicMoment:a}}_canEditByFeature(e){const{adds:t,updates:r}=e.editedFeatures;return t.every((e=>this.view.spatialReference.equals(e.geometry?.spatialReference)))&&r.every((e=>this.view.spatialReference.equals(e.current.geometry?.spatialReference)))}async _doUpdate(){"featureReduction"in this.layer&&this.layer.featureReduction&&this.layer.featureReduction!==this._lastFeatureReduction&&(this.layer.featureReduction=this.layer.featureReduction?.clone(),this._lastFeatureReduction=this.layer.featureReduction);try{if(await this._updateRequiredFields(),this.destroyed||!this.layerAdapter?.hasRequiredSupport||!this._subscriptionManager)return;const e=this.featureContainer.instanceStore;this.featureContainer.attributeView.lockTextureUploads(),e.updateStart();const t=this.featureEffect,r={store:e,cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},i=this._createViewSchemaConfig(),s={source:this.layerAdapter.createSourceSchema(i,this._sourceRefreshVersion),processor:await this.layerAdapter.createProcessorSchema(r,i,this._displayRefreshVersion)},a=u$c(this._lastSchema?.source.mutable,s.source.mutable)||u$c(this._lastSchema?.processor,s.processor);if(!a)return this.featureContainer.requestRender(),this.featureContainer.attributeView.unlockTextureUploads(),e.updateEnd(),void(this.featureEffectView.featureEffect=t);this._lastSchema=s,this._fields=null;const o=Math.round(performance.now());has("esri-2d-update-debug")&&console.debug(`Id[${this.layer.uid}] Version[${o}] FeatureLayerView2D._doUpdate`,{changes:a});const n=await this.getWorker();await n.pipeline.updateSchema(s,o),e.updateEnd(),this.featureEffectView.featureEffect=t,this.featureEffectView.endTransitions(),this.featureContainer.attributeView.unlockTextureUploads(),this.featureContainer.swapRenderState(),this.featureContainer.requestRender(),has("esri-2d-update-debug")&&console.debug(`Version[${o}] FeatureLayerView2D.updateEnd`),this.requestUpdate();}catch(e){has("esri-2d-update-debug")&&console.error("Encountered an error during update",e);}}async _doEdit(e){const t=await this.getWorker();try{this.featureContainer.editStart(),await t.pipeline.onEdits(e),this.featureContainer.editEnd();}catch(r){b$3(r);}}get hasFilter(){const e=this.layerAdapter.hasFilters?.(this.view)??!1;return null!=this.filter||null!=this.timeExtent||this._visibilityOverrides.size>0||e}_getEffectiveAvailableFields(e){const t=X(this._lastAvailableFields,e);return this._lastAvailableFields=t,T(this.layer.fieldsIndex,t)}_createViewSchemaConfig(){const e=[te(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter),this.featureEffect?.filter?.toJSON()??null];return {availableFields:this._getEffectiveAvailableFields(this.availableFields),filters:e,scale:this.view.scale,timeZone:this.view.timeZone}}_addHighlights(e,t){this._highlightCounter.addReason(e,t),this._commandsQueue.push({type:"highlight"});}_removeHighlights(e,t){this._highlightCounter.deleteReason(e,t),this._commandsQueue.push({type:"highlight"});}async _updateHighlights(){const e=[];for(const i of this._highlightCounter.ids()){const t=this._highlightCounter.getHighlightReason(i),r=t$a(t);e.push({objectId:i,highlightFlags:r});}const t=await this.getWorker();if(this.destroyed)return;const r=t.pipeline.updateHighlight({highlights:e}).catch((e=>{b$3(e)||n$5.getLogger(this).error(e);}));this._updatingHandles.addPromise(r);}_setLayersForFeature(e){e.layer=e.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin&&this.layerAdapter.setGraphicOrigin(e);}_createGraphicHit(e,t){return this._setLayersForFeature(t),null!=t.geometry&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};function te(e,t,r,i,s){s&&(s=s.clone());const a=null!=s?s.timeExtent:null,o=null!=r&&null!=a?r.intersection(a):r||a;o&&(s??=new d$6,s.timeExtent=o),s=t.addFilters?.(s,e)??s;let n=s?.toJSON()??null;return i.size&&(n??=(new d$6).toJSON(),n.hiddenIds=Array.from(i)),n}e$2([y$1()],ee.prototype,"_commandsQueue",void 0),e$2([y$1()],ee.prototype,"_sourceRefreshVersion",void 0),e$2([y$1()],ee.prototype,"_displayRefreshVersion",void 0),e$2([y$1({readOnly:!0})],ee.prototype,"_pipelineUpdating",void 0),e$2([y$1({readOnly:!0})],ee.prototype,"hasAllFeatures",null),e$2([y$1({readOnly:!0})],ee.prototype,"hasAllFeaturesInView",null),e$2([y$1({readOnly:!0})],ee.prototype,"hasFullGeometries",null),e$2([y$1()],ee.prototype,"featureEffectView",void 0),e$2([y$1()],ee.prototype,"labelingCollisionInfos",null),e$2([y$1()],ee.prototype,"layerAdapter",null),e$2([y$1({readOnly:!0})],ee.prototype,"timeExtent",null),e$2([y$1()],ee.prototype,"updating",void 0),ee=e$2([a$3("esri.views.2d.layers.FeatureLayerView2D")],ee);const re=ee;

const FeatureLayerView2D = /*#__PURE__*/Object.freeze(/*#__PURE__*/Object.defineProperty({
	__proto__: null,
	default: re
}, Symbol.toStringTag, { value: 'Module' }));

export { FeatureLayerView2D as F, n, re as r };
