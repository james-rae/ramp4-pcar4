const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./visualVariableUtils-BMp8yUlC.js","./main-CUxU9bWS.js","./preload-helper-ExcqyqRp.js","./main-wZMPJMua.css","./compilerUtils-MfGGJ6jp.js","./lengthUtils-D1bX0TD8.js","./sizeVariableUtils-Cmcuvw-4.js"])))=>i.map(i=>d[i]);
import{_ as O}from"./preload-helper-ExcqyqRp.js";import{aJ as A,q as d,u as m,C as H,aF as L,dO as E,aI as Q,s as F,V as $,bY as P,dt as G,aq as U,cy as M,eZ as z,a$ as q,e_ as j,aw as k,e$ as C,G as R,f0 as D,bt as J,bv as N,bO as W}from"./main-CUxU9bWS.js";import{H as Y}from"./languageUtils-yuBlGFLc.js";import{o as S}from"./drapedUtils-D3Xuf41N.js";import{n as Z,p as B}from"./popupUtils-GSlPvKwG.js";const V=A();let b=null;function oe(t,e){return e.type==="tile"||e.type==="map-image"}let y=class extends L{constructor(t){super(t),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=E(async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){const t=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([Q(()=>this.highlightGraphics,"change",e=>t(e.added),{onListenerAdd:e=>t(e)})])}async fetchPopupFeaturesAtLocation(t,e){const{layerView:{layer:s,view:{scale:n}}}=this;if(!t)throw new F("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:s});const r=K(s.sublayers,n,e);if(!r.length)return[];const a=await ee(s,r);if(!((s.capabilities?.operations?.supportsIdentify??!0)&&s.version>=10.5)&&!a)throw new F("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:s});return a?this._fetchPopupFeaturesUsingQueries(t,r,e):this._fetchPopupFeaturesUsingIdentify(t,r,e)}clearHighlights(){this.highlightGraphics?.removeAll()}highlight(t){const e=this.highlightGraphics;if(!t||!e)return V;let s=Y(t)?[t]:$.isCollection(t)?t.toArray():Array.isArray(t)?t:[];if(s=s?.filter(P),(s?.length??0)===0)return V;for(const n of s){const{sourceLayer:r}=n;r!=null&&"geometryType"in r&&r.geometryType==="point"&&(n.visible=!1)}return e.addMany(s),A(()=>e.removeMany(s??[]))}async _updateHighlightedFeaturesSymbols(t){const{layerView:{view:e},highlightGraphics:s,highlightGraphicUpdated:n}=this;if(s&&n)for(const r of t){const a=r.sourceLayer&&"renderer"in r.sourceLayer&&r.sourceLayer.renderer;r.sourceLayer&&"geometryType"in r.sourceLayer&&r.sourceLayer.geometryType==="point"&&a&&"getSymbolAsync"in a&&a.getSymbolAsync(r).then(async i=>{i||=new G;let c=null;const u="visualVariables"in a?a.visualVariables?.find(o=>o.type==="size"):void 0;u&&(b||(b=(await O(async()=>{const{getSize:o}=await import("./visualVariableUtils-BMp8yUlC.js");return{getSize:o}},__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url)).getSize),c=b(u,r,{view:e.type,scale:e.scale,shape:i.type==="simple-marker"?i.style:null})),c||="width"in i&&"height"in i&&i.width!=null&&i.height!=null?Math.max(i.width,i.height):"size"in i?i.size:16,s.includes(r)&&(r.symbol=new G({style:"square",size:c,xoffset:"xoffset"in i?i.xoffset:0,yoffset:"yoffset"in i?i.yoffset:0}),n(r,"symbol"),r.visible=!0)})}}async _updateHighlightedFeaturesGeometries(t){const{layerView:{layer:e,view:s},highlightGraphics:n,highlightGraphicUpdated:r}=this;if(this._highlightGeometriesResolution=t,!r||!n?.length||!e.capabilities.operations.supportsQuery)return;const a=this._getTargetResolution(t),i=new Map;for(const o of n)if(!this._featuresResolutions.has(o)||this._featuresResolutions.get(o)>a){const p=o.sourceLayer;U(i,p,()=>new Map).set(o.getObjectId(),o)}const c=Array.from(i,([o,p])=>{const l=o.createQuery();return l.objectIds=[...p.keys()],l.outFields=[o.objectIdField],l.returnGeometry=!0,l.maxAllowableOffset=a,l.outSpatialReference=s.spatialReference,o.queryFeatures(l)}),u=await Promise.all(c);if(!this.destroyed)for(const{features:o}of u)for(const p of o){const l=p.sourceLayer,h=i.get(l).get(p.getObjectId());h&&n.includes(h)&&(h.geometry=p.geometry,r(h,"geometry"),this._featuresResolutions.set(h,a))}}_getTargetResolution(t){const e=t*M(this.layerView.view.spatialReference),s=e/16;return s<=10?0:t/e*s}async _fetchPopupFeaturesUsingIdentify(t,e,s){const n=await this._createIdentifyParameters(t,e,s);if(n==null)return[];const{results:r}=await z(this.layerView.layer.parsedUrl,n,s);return r.map(a=>a.feature)}async _createIdentifyParameters(t,e,s){const{floors:n,layer:r,timeExtent:a,view:{spatialReference:i,scale:c}}=this.layerView;if(!e.length)return null;await Promise.all(e.map(({sublayer:f})=>f.load(s).catch(()=>{})));const u=Math.min(q("mapservice-popup-identify-max-tolerance"),r.allSublayers.reduce((f,g)=>g.renderer?S({renderer:g.renderer,pointerType:s?.pointerType}):f,2)),o=this.createFetchPopupFeaturesQueryGeometry(t,u),p=j(c,i),l=Math.round(o.width/p),h=new k({xmin:o.center.x-p*l,ymin:o.center.y-p*l,xmax:o.center.x+p*l,ymax:o.center.y+p*l,spatialReference:o.spatialReference});return new C({floors:n,gdbVersion:"gdbVersion"in r?r.gdbVersion:void 0,geometry:t,height:l,layerOption:"popup",mapExtent:h,returnGeometry:!0,spatialReference:i,sublayers:r.sublayers,timeExtent:a,tolerance:u,width:l})}async _fetchPopupFeaturesUsingQueries(t,e,s){const{layerView:{floors:n,timeExtent:r}}=this,a=e.map(async({sublayer:i,popupTemplate:c})=>{if(await i.load(s).catch(()=>{}),i.capabilities&&!i.capabilities.operations.supportsQuery)return[];const u=i.createQuery(),o=S({renderer:i.renderer,pointerType:s?.pointerType}),p=this.createFetchPopupFeaturesQueryGeometry(t,o),l=new Set,[h]=await Promise.all([Z(i,c),i.renderer?.collectRequiredFields(l,i.fieldsIndex)]);R(s),D(l,i.fieldsIndex,h);const f=Array.from(l).sort();u.geometry=p,u.outFields=f,u.timeExtent=r;const g=J(n,i);u.where=N(u.where,g);const v=this._getTargetResolution(p.width/o),_=await X(c);R(s);const x=i.geometryType==="point"||_&&_.arcadeUtils.hasGeometryOperations(c);x||(u.maxAllowableOffset=v);let{features:w}=await i.queryFeatures(u,s);const T=x?0:v;w=await te(i,w,s);for(const I of w)this._featuresResolutions.set(I,T);return w});return(await Promise.allSettled(a)).reduce((i,c)=>c.status==="fulfilled"?[...i,...c.value]:i,[]).filter(P)}};function K(t,e,s){const n=[];if(!t)return n;const r=a=>{const i=a.minScale===0||e<=a.minScale,c=a.maxScale===0||e>=a.maxScale;if(a.visible&&i&&c){if(a.sublayers)a.sublayers.forEach(r);else if(a.popupEnabled){const u=B(a,{...s,defaultPopupTemplateEnabled:!1});u!=null&&n.unshift({sublayer:a,popupTemplate:u})}}};return t.map(r),n}function X(t){return t.expressionInfos?.length||Array.isArray(t.content)&&t.content.some(e=>e.type==="expression")?W():Promise.resolve()}async function ee(t,e){if(t.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(e.map(({sublayer:s})=>s.load().then(()=>s.capabilities.operations.supportsQuery)))}catch{return!1}}async function te(t,e,s){const n=t.renderer;return n&&"defaultSymbol"in n&&!n.defaultSymbol&&(e=n.valueExpression?await Promise.all(e.map(r=>n.getSymbolAsync(r,s).then(a=>a?r:null))).then(r=>r.filter(a=>a!=null)):e.filter(r=>n.getSymbol(r)!=null)),e}d([m({constructOnly:!0})],y.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),d([m({constructOnly:!0})],y.prototype,"layerView",void 0),d([m({constructOnly:!0})],y.prototype,"highlightGraphics",void 0),d([m({constructOnly:!0})],y.prototype,"highlightGraphicUpdated",void 0),d([m({constructOnly:!0})],y.prototype,"updatingHandles",void 0),y=d([H("esri.views.layers.support.MapServiceLayerViewHelper")],y);export{y as R,oe as _};
