const k=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",B=k+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",Y="["+k+"]["+B+"]*",X=new RegExp("^"+Y+"$");function R(n,e){const t=[];let r=e.exec(n);for(;r;){const i=[];i.startIndex=e.lastIndex-r[0].length;const s=r.length;for(let o=0;o<s;o++)i.push(r[o]);t.push(i),r=e.exec(n)}return t}const O=function(n){const e=X.exec(n);return!(e===null||typeof e>"u")};function z(n){return typeof n<"u"}const Z={allowBooleanAttributes:!1,unpairedTags:[]};function W(n,e){e=Object.assign({},Z,e);const t=[];let r=!1,i=!1;n[0]==="\uFEFF"&&(n=n.substr(1));for(let s=0;s<n.length;s++)if(n[s]==="<"&&n[s+1]==="?"){if(s+=2,s=$(n,s),s.err)return s}else if(n[s]==="<"){let o=s;if(s++,n[s]==="!"){s=_(n,s);continue}else{let l=!1;n[s]==="/"&&(l=!0,s++);let f="";for(;s<n.length&&n[s]!==">"&&n[s]!==" "&&n[s]!=="	"&&n[s]!==`
`&&n[s]!=="\r";s++)f+=n[s];if(f=f.trim(),f[f.length-1]==="/"&&(f=f.substring(0,f.length-1),s--),!ee(f)){let d;return f.trim().length===0?d="Invalid space after '<'.":d="Tag '"+f+"' is an invalid name.",h("InvalidTag",d,p(n,s))}const u=G(n,s);if(u===!1)return h("InvalidAttr","Attributes for '"+f+"' have open quote.",p(n,s));let a=u.value;if(s=u.index,a[a.length-1]==="/"){const d=s-a.length;a=a.substring(0,a.length-1);const c=m(a,e);if(c===!0)r=!0;else return h(c.err.code,c.err.msg,p(n,d+c.err.line))}else if(l)if(u.tagClosed){if(a.trim().length>0)return h("InvalidTag","Closing tag '"+f+"' can't have attributes or invalid starting.",p(n,o));if(t.length===0)return h("InvalidTag","Closing tag '"+f+"' has not been opened.",p(n,o));{const d=t.pop();if(f!==d.tagName){let c=p(n,d.tagStartPos);return h("InvalidTag","Expected closing tag '"+d.tagName+"' (opened in line "+c.line+", col "+c.col+") instead of closing tag '"+f+"'.",p(n,o))}t.length==0&&(i=!0)}}else return h("InvalidTag","Closing tag '"+f+"' doesn't have proper closing.",p(n,s));else{const d=m(a,e);if(d!==!0)return h(d.err.code,d.err.msg,p(n,s-a.length+d.err.line));if(i===!0)return h("InvalidXml","Multiple possible root nodes found.",p(n,s));e.unpairedTags.indexOf(f)!==-1||t.push({tagName:f,tagStartPos:o}),r=!0}for(s++;s<n.length;s++)if(n[s]==="<")if(n[s+1]==="!"){s++,s=_(n,s);continue}else if(n[s+1]==="?"){if(s=$(n,++s),s.err)return s}else break;else if(n[s]==="&"){const d=H(n,s);if(d==-1)return h("InvalidChar","char '&' is not expected.",p(n,s));s=d}else if(i===!0&&!M(n[s]))return h("InvalidXml","Extra text at the end",p(n,s));n[s]==="<"&&s--}}else{if(M(n[s]))continue;return h("InvalidChar","char '"+n[s]+"' is not expected.",p(n,s))}if(r){if(t.length==1)return h("InvalidTag","Unclosed tag '"+t[0].tagName+"'.",p(n,t[0].tagStartPos));if(t.length>0)return h("InvalidXml","Invalid '"+JSON.stringify(t.map(s=>s.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return h("InvalidXml","Start tag expected.",1);return!0}function M(n){return n===" "||n==="	"||n===`
`||n==="\r"}function $(n,e){const t=e;for(;e<n.length;e++)if(n[e]=="?"||n[e]==" "){const r=n.substr(t,e-t);if(e>5&&r==="xml")return h("InvalidXml","XML declaration allowed only at the start of the document.",p(n,e));if(n[e]=="?"&&n[e+1]==">"){e++;break}else continue}return e}function _(n,e){if(n.length>e+5&&n[e+1]==="-"&&n[e+2]==="-"){for(e+=3;e<n.length;e++)if(n[e]==="-"&&n[e+1]==="-"&&n[e+2]===">"){e+=2;break}}else if(n.length>e+8&&n[e+1]==="D"&&n[e+2]==="O"&&n[e+3]==="C"&&n[e+4]==="T"&&n[e+5]==="Y"&&n[e+6]==="P"&&n[e+7]==="E"){let t=1;for(e+=8;e<n.length;e++)if(n[e]==="<")t++;else if(n[e]===">"&&(t--,t===0))break}else if(n.length>e+9&&n[e+1]==="["&&n[e+2]==="C"&&n[e+3]==="D"&&n[e+4]==="A"&&n[e+5]==="T"&&n[e+6]==="A"&&n[e+7]==="["){for(e+=8;e<n.length;e++)if(n[e]==="]"&&n[e+1]==="]"&&n[e+2]===">"){e+=2;break}}return e}const q='"',Q="'";function G(n,e){let t="",r="",i=!1;for(;e<n.length;e++){if(n[e]===q||n[e]===Q)r===""?r=n[e]:r!==n[e]||(r="");else if(n[e]===">"&&r===""){i=!0;break}t+=n[e]}return r!==""?!1:{value:t,index:e,tagClosed:i}}const K=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function m(n,e){const t=R(n,K),r={};for(let i=0;i<t.length;i++){if(t[i][1].length===0)return h("InvalidAttr","Attribute '"+t[i][2]+"' has no space in starting.",I(t[i]));if(t[i][3]!==void 0&&t[i][4]===void 0)return h("InvalidAttr","Attribute '"+t[i][2]+"' is without value.",I(t[i]));if(t[i][3]===void 0&&!e.allowBooleanAttributes)return h("InvalidAttr","boolean attribute '"+t[i][2]+"' is not allowed.",I(t[i]));const s=t[i][2];if(!D(s))return h("InvalidAttr","Attribute '"+s+"' is an invalid name.",I(t[i]));if(!r.hasOwnProperty(s))r[s]=1;else return h("InvalidAttr","Attribute '"+s+"' is repeated.",I(t[i]))}return!0}function J(n,e){let t=/\d/;for(n[e]==="x"&&(e++,t=/[\da-fA-F]/);e<n.length;e++){if(n[e]===";")return e;if(!n[e].match(t))break}return-1}function H(n,e){if(e++,n[e]===";")return-1;if(n[e]==="#")return e++,J(n,e);let t=0;for(;e<n.length;e++,t++)if(!(n[e].match(/\w/)&&t<20)){if(n[e]===";")break;return-1}return e}function h(n,e,t){return{err:{code:n,msg:e,line:t.line||t,col:t.col}}}function D(n){return O(n)}function ee(n){return O(n)}function p(n,e){const t=n.substring(0,e).split(/\r?\n/);return{line:t.length,col:t[t.length-1].length+1}}function I(n){return n.startIndex+n[1].length}const te={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(n,e){return e},attributeValueProcessor:function(n,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(n,e,t){return n},captureMetaData:!1};function U(n){return typeof n=="boolean"?{enabled:n,maxEntitySize:1e4,maxExpansionDepth:10,maxTotalExpansions:1e3,maxExpandedLength:1e5,allowedTags:null,tagFilter:null}:typeof n=="object"&&n!==null?{enabled:n.enabled!==!1,maxEntitySize:n.maxEntitySize??1e4,maxExpansionDepth:n.maxExpansionDepth??10,maxTotalExpansions:n.maxTotalExpansions??1e3,maxExpandedLength:n.maxExpandedLength??1e5,allowedTags:n.allowedTags??null,tagFilter:n.tagFilter??null}:U(!0)}const ne=function(n){const e=Object.assign({},te,n);return e.processEntities=U(e.processEntities),e};let A;typeof Symbol!="function"?A="@@xmlMetadata":A=Symbol("XML Node Metadata");class T{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){e==="__proto__"&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e,t){e.tagname==="__proto__"&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child}),t!==void 0&&(this.child[this.child.length-1][A]={startIndex:t})}static getMetaDataSymbol(){return A}}class se{constructor(e){this.suppressValidationErr=!e,this.options=e}readDocType(e,t){const r={};if(e[t+3]==="O"&&e[t+4]==="C"&&e[t+5]==="T"&&e[t+6]==="Y"&&e[t+7]==="P"&&e[t+8]==="E"){t=t+9;let i=1,s=!1,o=!1,l="";for(;t<e.length;t++)if(e[t]==="<"&&!o){if(s&&N(e,"!ENTITY",t)){t+=7;let f,u;if([f,u,t]=this.readEntityExp(e,t+1,this.suppressValidationErr),u.indexOf("&")===-1){const a=f.replace(/[.\-+*:]/g,"\\.");r[f]={regx:RegExp(`&${a};`,"g"),val:u}}}else if(s&&N(e,"!ELEMENT",t)){t+=8;const{index:f}=this.readElementExp(e,t+1);t=f}else if(s&&N(e,"!ATTLIST",t))t+=8;else if(s&&N(e,"!NOTATION",t)){t+=9;const{index:f}=this.readNotationExp(e,t+1,this.suppressValidationErr);t=f}else if(N(e,"!--",t))o=!0;else throw new Error("Invalid DOCTYPE");i++,l=""}else if(e[t]===">"){if(o?e[t-1]==="-"&&e[t-2]==="-"&&(o=!1,i--):i--,i===0)break}else e[t]==="["?s=!0:l+=e[t];if(i!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:r,i:t}}readEntityExp(e,t){t=E(e,t);let r="";for(;t<e.length&&!/\s/.test(e[t])&&e[t]!=='"'&&e[t]!=="'";)r+=e[t],t++;if(y(r),t=E(e,t),!this.suppressValidationErr){if(e.substring(t,t+6).toUpperCase()==="SYSTEM")throw new Error("External entities are not supported");if(e[t]==="%")throw new Error("Parameter entities are not supported")}let i="";if([t,i]=this.readIdentifierVal(e,t,"entity"),this.options.enabled!==!1&&this.options.maxEntitySize&&i.length>this.options.maxEntitySize)throw new Error(`Entity "${r}" size (${i.length}) exceeds maximum allowed size (${this.options.maxEntitySize})`);return t--,[r,i,t]}readNotationExp(e,t){t=E(e,t);let r="";for(;t<e.length&&!/\s/.test(e[t]);)r+=e[t],t++;!this.suppressValidationErr&&y(r),t=E(e,t);const i=e.substring(t,t+6).toUpperCase();if(!this.suppressValidationErr&&i!=="SYSTEM"&&i!=="PUBLIC")throw new Error(`Expected SYSTEM or PUBLIC, found "${i}"`);t+=i.length,t=E(e,t);let s=null,o=null;if(i==="PUBLIC")[t,s]=this.readIdentifierVal(e,t,"publicIdentifier"),t=E(e,t),(e[t]==='"'||e[t]==="'")&&([t,o]=this.readIdentifierVal(e,t,"systemIdentifier"));else if(i==="SYSTEM"&&([t,o]=this.readIdentifierVal(e,t,"systemIdentifier"),!this.suppressValidationErr&&!o))throw new Error("Missing mandatory system identifier for SYSTEM notation");return{notationName:r,publicIdentifier:s,systemIdentifier:o,index:--t}}readIdentifierVal(e,t,r){let i="";const s=e[t];if(s!=='"'&&s!=="'")throw new Error(`Expected quoted string, found "${s}"`);for(t++;t<e.length&&e[t]!==s;)i+=e[t],t++;if(e[t]!==s)throw new Error(`Unterminated ${r} value`);return t++,[t,i]}readElementExp(e,t){t=E(e,t);let r="";for(;t<e.length&&!/\s/.test(e[t]);)r+=e[t],t++;if(!this.suppressValidationErr&&!O(r))throw new Error(`Invalid element name: "${r}"`);t=E(e,t);let i="";if(e[t]==="E"&&N(e,"MPTY",t))t+=4;else if(e[t]==="A"&&N(e,"NY",t))t+=2;else if(e[t]==="("){for(t++;t<e.length&&e[t]!==")";)i+=e[t],t++;if(e[t]!==")")throw new Error("Unterminated content model")}else if(!this.suppressValidationErr)throw new Error(`Invalid Element Expression, found "${e[t]}"`);return{elementName:r,contentModel:i.trim(),index:t}}readAttlistExp(e,t){t=E(e,t);let r="";for(;t<e.length&&!/\s/.test(e[t]);)r+=e[t],t++;y(r),t=E(e,t);let i="";for(;t<e.length&&!/\s/.test(e[t]);)i+=e[t],t++;if(!y(i))throw new Error(`Invalid attribute name: "${i}"`);t=E(e,t);let s="";if(e.substring(t,t+8).toUpperCase()==="NOTATION"){if(s="NOTATION",t+=8,t=E(e,t),e[t]!=="(")throw new Error(`Expected '(', found "${e[t]}"`);t++;let l=[];for(;t<e.length&&e[t]!==")";){let f="";for(;t<e.length&&e[t]!=="|"&&e[t]!==")";)f+=e[t],t++;if(f=f.trim(),!y(f))throw new Error(`Invalid notation name: "${f}"`);l.push(f),e[t]==="|"&&(t++,t=E(e,t))}if(e[t]!==")")throw new Error("Unterminated list of notations");t++,s+=" ("+l.join("|")+")"}else{for(;t<e.length&&!/\s/.test(e[t]);)s+=e[t],t++;const l=["CDATA","ID","IDREF","IDREFS","ENTITY","ENTITIES","NMTOKEN","NMTOKENS"];if(!this.suppressValidationErr&&!l.includes(s.toUpperCase()))throw new Error(`Invalid attribute type: "${s}"`)}t=E(e,t);let o="";return e.substring(t,t+8).toUpperCase()==="#REQUIRED"?(o="#REQUIRED",t+=8):e.substring(t,t+7).toUpperCase()==="#IMPLIED"?(o="#IMPLIED",t+=7):[t,o]=this.readIdentifierVal(e,t,"ATTLIST"),{elementName:r,attributeName:i,attributeType:s,defaultValue:o,index:t}}}const E=(n,e)=>{for(;e<n.length&&/\s/.test(n[e]);)e++;return e};function N(n,e,t){for(let r=0;r<e.length;r++)if(e[r]!==n[t+r+1])return!1;return!0}function y(n){if(O(n))return n;throw new Error(`Invalid entity name ${n}`)}const re=/^[-+]?0x[a-fA-F0-9]+$/,ie=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,oe={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function fe(n,e={}){if(e=Object.assign({},oe,e),!n||typeof n!="string")return n;let t=n.trim();if(e.skipLike!==void 0&&e.skipLike.test(t))return n;if(n==="0")return 0;if(e.hex&&re.test(t))return ae(t,16);if(t.includes("e")||t.includes("E"))return le(n,t,e);{const r=ie.exec(t);if(r){const i=r[1]||"",s=r[2];let o=de(r[3]);const l=i?n[s.length+1]===".":n[s.length]===".";if(!e.leadingZeros&&(s.length>1||s.length===1&&!l))return n;{const f=Number(t),u=String(f);if(f===0)return f;if(u.search(/[eE]/)!==-1)return e.eNotation?f:n;if(t.indexOf(".")!==-1)return u==="0"||u===o||u===`${i}${o}`?f:n;let a=s?o:t;return s?a===u||i+a===u?f:n:a===u||a===i+u?f:n}}else return n}}const ue=/^([-+])?(0*)(\d*(\.\d*)?[eE][-\+]?\d+)$/;function le(n,e,t){if(!t.eNotation)return n;const r=e.match(ue);if(r){let i=r[1]||"";const s=r[3].indexOf("e")===-1?"E":"e",o=r[2],l=i?n[o.length+1]===s:n[o.length]===s;return o.length>1&&l?n:o.length===1&&(r[3].startsWith(`.${s}`)||r[3][0]===s)?Number(e):t.leadingZeros&&!l?(e=(r[1]||"")+r[3],Number(e)):n}else return n}function de(n){return n&&n.indexOf(".")!==-1&&(n=n.replace(/0+$/,""),n==="."?n="0":n[0]==="."?n="0"+n:n[n.length-1]==="."&&(n=n.substring(0,n.length-1))),n}function ae(n,e){if(parseInt)return parseInt(n,e);if(Number.parseInt)return Number.parseInt(n,e);if(window&&window.parseInt)return window.parseInt(n,e);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}function he(n){return typeof n=="function"?n:Array.isArray(n)?e=>{for(const t of n)if(typeof t=="string"&&e===t||t instanceof RegExp&&t.test(e))return!0}:()=>!1}class ce{constructor(e){if(this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(t,r)=>L(r,10,"&#")},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(t,r)=>L(r,16,"&#x")}},this.addExternalEntities=ge,this.parseXml=be,this.parseTextData=pe,this.resolveNameSpace=Ee,this.buildAttributesMap=Te,this.isItStopNode=Ae,this.replaceEntitiesValue=Ie,this.readStopNodeData=Ce,this.saveTextToParentTag=ye,this.addChild=we,this.ignoreAttributesFn=he(this.options.ignoreAttributes),this.entityExpansionCount=0,this.currentExpandedLength=0,this.options.stopNodes&&this.options.stopNodes.length>0){this.stopNodesExact=new Set,this.stopNodesWildcard=new Set;for(let t=0;t<this.options.stopNodes.length;t++){const r=this.options.stopNodes[t];typeof r=="string"&&(r.startsWith("*.")?this.stopNodesWildcard.add(r.substring(2)):this.stopNodesExact.add(r))}}}}function ge(n){const e=Object.keys(n);for(let t=0;t<e.length;t++){const r=e[t],i=r.replace(/[.\-+*:]/g,"\\.");this.lastEntities[r]={regex:new RegExp("&"+i+";","g"),val:n[r]}}}function pe(n,e,t,r,i,s,o){if(n!==void 0&&(this.options.trimValues&&!r&&(n=n.trim()),n.length>0)){o||(n=this.replaceEntitiesValue(n,e,t));const l=this.options.tagValueProcessor(e,n,t,i,s);return l==null?n:typeof l!=typeof n||l!==n?l:this.options.trimValues?V(n,this.options.parseTagValue,this.options.numberParseOptions):n.trim()===n?V(n,this.options.parseTagValue,this.options.numberParseOptions):n}}function Ee(n){if(this.options.removeNSPrefix){const e=n.split(":"),t=n.charAt(0)==="/"?"/":"";if(e[0]==="xmlns")return"";e.length===2&&(n=t+e[1])}return n}const Ne=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function Te(n,e,t){if(this.options.ignoreAttributes!==!0&&typeof n=="string"){const r=R(n,Ne),i=r.length,s={};for(let o=0;o<i;o++){const l=this.resolveNameSpace(r[o][1]);if(this.ignoreAttributesFn(l,e))continue;let f=r[o][4],u=this.options.attributeNamePrefix+l;if(l.length)if(this.options.transformAttributeName&&(u=this.options.transformAttributeName(u)),u==="__proto__"&&(u="#__proto__"),f!==void 0){this.options.trimValues&&(f=f.trim()),f=this.replaceEntitiesValue(f,t,e);const a=this.options.attributeValueProcessor(l,f,e);a==null?s[u]=f:typeof a!=typeof f||a!==f?s[u]=a:s[u]=V(f,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(s[u]=!0)}if(!Object.keys(s).length)return;if(this.options.attributesGroupName){const o={};return o[this.options.attributesGroupName]=s,o}return s}}const be=function(n){n=n.replace(/\r\n?/g,`
`);const e=new T("!xml");let t=e,r="",i="";this.entityExpansionCount=0,this.currentExpandedLength=0;const s=new se(this.options.processEntities);for(let o=0;o<n.length;o++)if(n[o]==="<")if(n[o+1]==="/"){const f=b(n,">",o,"Closing Tag is not closed.");let u=n.substring(o+2,f).trim();if(this.options.removeNSPrefix){const c=u.indexOf(":");c!==-1&&(u=u.substr(c+1))}this.options.transformTagName&&(u=this.options.transformTagName(u)),t&&(r=this.saveTextToParentTag(r,t,i));const a=i.substring(i.lastIndexOf(".")+1);if(u&&this.options.unpairedTags.indexOf(u)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${u}>`);let d=0;a&&this.options.unpairedTags.indexOf(a)!==-1?(d=i.lastIndexOf(".",i.lastIndexOf(".")-1),this.tagsNodeStack.pop()):d=i.lastIndexOf("."),i=i.substring(0,d),t=this.tagsNodeStack.pop(),r="",o=f}else if(n[o+1]==="?"){let f=F(n,o,!1,"?>");if(!f)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,t,i),!(this.options.ignoreDeclaration&&f.tagName==="?xml"||this.options.ignorePiTags)){const u=new T(f.tagName);u.add(this.options.textNodeName,""),f.tagName!==f.tagExp&&f.attrExpPresent&&(u[":@"]=this.buildAttributesMap(f.tagExp,i,f.tagName)),this.addChild(t,u,i,o)}o=f.closeIndex+1}else if(n.substr(o+1,3)==="!--"){const f=b(n,"-->",o+4,"Comment is not closed.");if(this.options.commentPropName){const u=n.substring(o+4,f-2);r=this.saveTextToParentTag(r,t,i),t.add(this.options.commentPropName,[{[this.options.textNodeName]:u}])}o=f}else if(n.substr(o+1,2)==="!D"){const f=s.readDocType(n,o);this.docTypeEntities=f.entities,o=f.i}else if(n.substr(o+1,2)==="!["){const f=b(n,"]]>",o,"CDATA is not closed.")-2,u=n.substring(o+9,f);r=this.saveTextToParentTag(r,t,i);let a=this.parseTextData(u,t.tagname,i,!0,!1,!0,!0);a==null&&(a=""),this.options.cdataPropName?t.add(this.options.cdataPropName,[{[this.options.textNodeName]:u}]):t.add(this.options.textNodeName,a),o=f+2}else{let f=F(n,o,this.options.removeNSPrefix),u=f.tagName;const a=f.rawTagName;let d=f.tagExp,c=f.attrExpPresent,v=f.closeIndex;if(this.options.transformTagName){const g=this.options.transformTagName(u);d===u&&(d=g),u=g}t&&r&&t.tagname!=="!xml"&&(r=this.saveTextToParentTag(r,t,i,!1));const x=t;x&&this.options.unpairedTags.indexOf(x.tagname)!==-1&&(t=this.tagsNodeStack.pop(),i=i.substring(0,i.lastIndexOf("."))),u!==e.tagname&&(i+=i?"."+u:u);const C=o;if(this.isItStopNode(this.stopNodesExact,this.stopNodesWildcard,i,u)){let g="";if(d.length>0&&d.lastIndexOf("/")===d.length-1)u[u.length-1]==="/"?(u=u.substr(0,u.length-1),i=i.substr(0,i.length-1),d=u):d=d.substr(0,d.length-1),o=f.closeIndex;else if(this.options.unpairedTags.indexOf(u)!==-1)o=f.closeIndex;else{const P=this.readStopNodeData(n,a,v+1);if(!P)throw new Error(`Unexpected end of ${a}`);o=P.i,g=P.tagContent}const w=new T(u);u!==d&&c&&(w[":@"]=this.buildAttributesMap(d,i,u)),g&&(g=this.parseTextData(g,u,i,!0,c,!0,!0)),i=i.substr(0,i.lastIndexOf(".")),w.add(this.options.textNodeName,g),this.addChild(t,w,i,C)}else{if(d.length>0&&d.lastIndexOf("/")===d.length-1){if(u[u.length-1]==="/"?(u=u.substr(0,u.length-1),i=i.substr(0,i.length-1),d=u):d=d.substr(0,d.length-1),this.options.transformTagName){const w=this.options.transformTagName(u);d===u&&(d=w),u=w}const g=new T(u);u!==d&&c&&(g[":@"]=this.buildAttributesMap(d,i,u)),this.addChild(t,g,i,C),i=i.substr(0,i.lastIndexOf("."))}else{const g=new T(u);this.tagsNodeStack.push(t),u!==d&&c&&(g[":@"]=this.buildAttributesMap(d,i,u)),this.addChild(t,g,i,C),t=g}r="",o=v}}else r+=n[o];return e.child};function we(n,e,t,r){this.options.captureMetaData||(r=void 0);const i=this.options.updateTag(e.tagname,t,e[":@"]);i===!1||(typeof i=="string"&&(e.tagname=i),n.addChild(e,r))}const Ie=function(n,e,t){if(n.indexOf("&")===-1)return n;const r=this.options.processEntities;if(!r.enabled||r.allowedTags&&!r.allowedTags.includes(e)||r.tagFilter&&!r.tagFilter(e,t))return n;for(let i in this.docTypeEntities){const s=this.docTypeEntities[i],o=n.match(s.regx);if(o){if(this.entityExpansionCount+=o.length,r.maxTotalExpansions&&this.entityExpansionCount>r.maxTotalExpansions)throw new Error(`Entity expansion limit exceeded: ${this.entityExpansionCount} > ${r.maxTotalExpansions}`);const l=n.length;if(n=n.replace(s.regx,s.val),r.maxExpandedLength&&(this.currentExpandedLength+=n.length-l,this.currentExpandedLength>r.maxExpandedLength))throw new Error(`Total expanded content size exceeded: ${this.currentExpandedLength} > ${r.maxExpandedLength}`)}}if(n.indexOf("&")===-1)return n;for(let i in this.lastEntities){const s=this.lastEntities[i];n=n.replace(s.regex,s.val)}if(n.indexOf("&")===-1)return n;if(this.options.htmlEntities)for(let i in this.htmlEntities){const s=this.htmlEntities[i];n=n.replace(s.regex,s.val)}return n=n.replace(this.ampEntity.regex,this.ampEntity.val),n};function ye(n,e,t,r){return n&&(r===void 0&&(r=e.child.length===0),n=this.parseTextData(n,e.tagname,t,!1,e[":@"]?Object.keys(e[":@"]).length!==0:!1,r),n!==void 0&&n!==""&&e.add(this.options.textNodeName,n),n=""),n}function Ae(n,e,t,r){return!!(e&&e.has(r)||n&&n.has(t))}function Oe(n,e,t=">"){let r,i="";for(let s=e;s<n.length;s++){let o=n[s];if(r)o===r&&(r="");else if(o==='"'||o==="'")r=o;else if(o===t[0])if(t[1]){if(n[s+1]===t[1])return{data:i,index:s}}else return{data:i,index:s};else o==="	"&&(o=" ");i+=o}}function b(n,e,t,r){const i=n.indexOf(e,t);if(i===-1)throw new Error(r);return i+e.length-1}function F(n,e,t,r=">"){const i=Oe(n,e+1,r);if(!i)return;let s=i.data;const o=i.index,l=s.search(/\s/);let f=s,u=!0;l!==-1&&(f=s.substring(0,l),s=s.substring(l+1).trimStart());const a=f;if(t){const d=f.indexOf(":");d!==-1&&(f=f.substr(d+1),u=f!==i.data.substr(d+1))}return{tagName:f,tagExp:s,closeIndex:o,attrExpPresent:u,rawTagName:a}}function Ce(n,e,t){const r=t;let i=1;for(;t<n.length;t++)if(n[t]==="<")if(n[t+1]==="/"){const s=b(n,">",t,`${e} is not closed`);if(n.substring(t+2,s).trim()===e&&(i--,i===0))return{tagContent:n.substring(r,t),i:s};t=s}else if(n[t+1]==="?")t=b(n,"?>",t+1,"StopNode is not closed.");else if(n.substr(t+1,3)==="!--")t=b(n,"-->",t+3,"StopNode is not closed.");else if(n.substr(t+1,2)==="![")t=b(n,"]]>",t,"StopNode is not closed.")-2;else{const s=F(n,t,">");s&&((s&&s.tagName)===e&&s.tagExp[s.tagExp.length-1]!=="/"&&i++,t=s.closeIndex)}}function V(n,e,t){if(e&&typeof n=="string"){const r=n.trim();return r==="true"?!0:r==="false"?!1:fe(n,t)}else return z(n)?n:""}function L(n,e,t){const r=Number.parseInt(n,e);return r>=0&&r<=1114111?String.fromCodePoint(r):t+n+";"}const S=T.getMetaDataSymbol();function Pe(n,e){return j(n,e)}function j(n,e,t){let r;const i={};for(let s=0;s<n.length;s++){const o=n[s],l=Se(o);let f="";if(t===void 0?f=l:f=t+"."+l,l===e.textNodeName)r===void 0?r=o[l]:r+=""+o[l];else{if(l===void 0)continue;if(o[l]){let u=j(o[l],e,f);const a=Ve(u,e);o[S]!==void 0&&(u[S]=o[S]),o[":@"]?Fe(u,o[":@"],f,e):Object.keys(u).length===1&&u[e.textNodeName]!==void 0&&!e.alwaysCreateTextNode?u=u[e.textNodeName]:Object.keys(u).length===0&&(e.alwaysCreateTextNode?u[e.textNodeName]="":u=""),i[l]!==void 0&&i.hasOwnProperty(l)?(Array.isArray(i[l])||(i[l]=[i[l]]),i[l].push(u)):e.isArray(l,f,a)?i[l]=[u]:i[l]=u}}}return typeof r=="string"?r.length>0&&(i[e.textNodeName]=r):r!==void 0&&(i[e.textNodeName]=r),i}function Se(n){const e=Object.keys(n);for(let t=0;t<e.length;t++){const r=e[t];if(r!==":@")return r}}function Fe(n,e,t,r){if(e){const i=Object.keys(e),s=i.length;for(let o=0;o<s;o++){const l=i[o];r.isArray(l,t+"."+l,!0,!0)?n[l]=[e[l]]:n[l]=e[l]}}}function Ve(n,e){const{textNodeName:t}=e,r=Object.keys(n).length;return!!(r===0||r===1&&(n[t]||typeof n[t]=="boolean"||n[t]===0))}class ve{constructor(e){this.externalEntities={},this.options=ne(e)}parse(e,t){if(typeof e!="string"&&e.toString)e=e.toString();else if(typeof e!="string")throw new Error("XML data is accepted in String or Bytes[] form.");if(t){t===!0&&(t={});const s=W(e,t);if(s!==!0)throw Error(`${s.err.msg}:${s.err.line}:${s.err.col}`)}const r=new ce(this.options);r.addExternalEntities(this.externalEntities);const i=r.parseXml(e);return this.options.preserveOrder||i===void 0?i:Pe(i,this.options)}addEntity(e,t){if(t.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(e.indexOf("&")!==-1||e.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(t==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}static getMetaDataSymbol(){return T.getMetaDataSymbol()}}export{ve as XMLParser};
