const D=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",j=D+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",Y="["+D+"]["+j+"]*",R=new RegExp("^"+Y+"$");function F(i,t){const e=[];let r=t.exec(i);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const s=r.length;for(let a=0;a<s;a++)o.push(r[a]);e.push(o),r=t.exec(i)}return e}const v=function(i){const t=R.exec(i);return!(t===null||typeof t>"u")};function X(i){return typeof i<"u"}const z={allowBooleanAttributes:!1,unpairedTags:[]};function B(i,t){t=Object.assign({},z,t);const e=[];let r=!1,o=!1;i[0]==="\uFEFF"&&(i=i.substr(1));for(let s=0;s<i.length;s++)if(i[s]==="<"&&i[s+1]==="?"){if(s+=2,s=$(i,s),s.err)return s}else if(i[s]==="<"){let a=s;if(s++,i[s]==="!"){s=M(i,s);continue}else{let l=!1;i[s]==="/"&&(l=!0,s++);let n="";for(;s<i.length&&i[s]!==">"&&i[s]!==" "&&i[s]!=="	"&&i[s]!==`
`&&i[s]!=="\r";s++)n+=i[s];if(n=n.trim(),n[n.length-1]==="/"&&(n=n.substring(0,n.length-1),s--),!H(n)){let h;return n.trim().length===0?h="Invalid space after '<'.":h="Tag '"+n+"' is an invalid name.",f("InvalidTag",h,p(i,s))}const d=q(i,s);if(d===!1)return f("InvalidAttr","Attributes for '"+n+"' have open quote.",p(i,s));let u=d.value;if(s=d.index,u[u.length-1]==="/"){const h=s-u.length;u=u.substring(0,u.length-1);const x=_(u,t);if(x===!0)r=!0;else return f(x.err.code,x.err.msg,p(i,h+x.err.line))}else if(l)if(d.tagClosed){if(u.trim().length>0)return f("InvalidTag","Closing tag '"+n+"' can't have attributes or invalid starting.",p(i,a));if(e.length===0)return f("InvalidTag","Closing tag '"+n+"' has not been opened.",p(i,a));{const h=e.pop();if(n!==h.tagName){let x=p(i,h.tagStartPos);return f("InvalidTag","Expected closing tag '"+h.tagName+"' (opened in line "+x.line+", col "+x.col+") instead of closing tag '"+n+"'.",p(i,a))}e.length==0&&(o=!0)}}else return f("InvalidTag","Closing tag '"+n+"' doesn't have proper closing.",p(i,s));else{const h=_(u,t);if(h!==!0)return f(h.err.code,h.err.msg,p(i,s-u.length+h.err.line));if(o===!0)return f("InvalidXml","Multiple possible root nodes found.",p(i,s));t.unpairedTags.indexOf(n)!==-1||e.push({tagName:n,tagStartPos:a}),r=!0}for(s++;s<i.length;s++)if(i[s]==="<")if(i[s+1]==="!"){s++,s=M(i,s);continue}else if(i[s+1]==="?"){if(s=$(i,++s),s.err)return s}else break;else if(i[s]==="&"){const h=Q(i,s);if(h==-1)return f("InvalidChar","char '&' is not expected.",p(i,s));s=h}else if(o===!0&&!V(i[s]))return f("InvalidXml","Extra text at the end",p(i,s));i[s]==="<"&&s--}}else{if(V(i[s]))continue;return f("InvalidChar","char '"+i[s]+"' is not expected.",p(i,s))}if(r){if(e.length==1)return f("InvalidTag","Unclosed tag '"+e[0].tagName+"'.",p(i,e[0].tagStartPos));if(e.length>0)return f("InvalidXml","Invalid '"+JSON.stringify(e.map(s=>s.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return f("InvalidXml","Start tag expected.",1);return!0}function V(i){return i===" "||i==="	"||i===`
`||i==="\r"}function $(i,t){const e=t;for(;t<i.length;t++)if(i[t]=="?"||i[t]==" "){const r=i.substr(e,t-e);if(t>5&&r==="xml")return f("InvalidXml","XML declaration allowed only at the start of the document.",p(i,t));if(i[t]=="?"&&i[t+1]==">"){t++;break}else continue}return t}function M(i,t){if(i.length>t+5&&i[t+1]==="-"&&i[t+2]==="-"){for(t+=3;t<i.length;t++)if(i[t]==="-"&&i[t+1]==="-"&&i[t+2]===">"){t+=2;break}}else if(i.length>t+8&&i[t+1]==="D"&&i[t+2]==="O"&&i[t+3]==="C"&&i[t+4]==="T"&&i[t+5]==="Y"&&i[t+6]==="P"&&i[t+7]==="E"){let e=1;for(t+=8;t<i.length;t++)if(i[t]==="<")e++;else if(i[t]===">"&&(e--,e===0))break}else if(i.length>t+9&&i[t+1]==="["&&i[t+2]==="C"&&i[t+3]==="D"&&i[t+4]==="A"&&i[t+5]==="T"&&i[t+6]==="A"&&i[t+7]==="["){for(t+=8;t<i.length;t++)if(i[t]==="]"&&i[t+1]==="]"&&i[t+2]===">"){t+=2;break}}return t}const W='"',Z="'";function q(i,t){let e="",r="",o=!1;for(;t<i.length;t++){if(i[t]===W||i[t]===Z)r===""?r=i[t]:r!==i[t]||(r="");else if(i[t]===">"&&r===""){o=!0;break}e+=i[t]}return r!==""?!1:{value:e,index:t,tagClosed:o}}const G=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function _(i,t){const e=F(i,G),r={};for(let o=0;o<e.length;o++){if(e[o][1].length===0)return f("InvalidAttr","Attribute '"+e[o][2]+"' has no space in starting.",T(e[o]));if(e[o][3]!==void 0&&e[o][4]===void 0)return f("InvalidAttr","Attribute '"+e[o][2]+"' is without value.",T(e[o]));if(e[o][3]===void 0&&!t.allowBooleanAttributes)return f("InvalidAttr","boolean attribute '"+e[o][2]+"' is not allowed.",T(e[o]));const s=e[o][2];if(!J(s))return f("InvalidAttr","Attribute '"+s+"' is an invalid name.",T(e[o]));if(!r.hasOwnProperty(s))r[s]=1;else return f("InvalidAttr","Attribute '"+s+"' is repeated.",T(e[o]))}return!0}function K(i,t){let e=/\d/;for(i[t]==="x"&&(t++,e=/[\da-fA-F]/);t<i.length;t++){if(i[t]===";")return t;if(!i[t].match(e))break}return-1}function Q(i,t){if(t++,i[t]===";")return-1;if(i[t]==="#")return t++,K(i,t);let e=0;for(;t<i.length;t++,e++)if(!(i[t].match(/\w/)&&e<20)){if(i[t]===";")break;return-1}return t}function f(i,t,e){return{err:{code:i,msg:t,line:e.line||e,col:e.col}}}function J(i){return v(i)}function H(i){return v(i)}function p(i,t){const e=i.substring(0,t).split(/\r?\n/);return{line:e.length,col:e[e.length-1].length+1}}function T(i){return i.startIndex+i[1].length}const tt={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(i,t){return t},attributeValueProcessor:function(i,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(i,t,e){return i},captureMetaData:!1};function k(i){return typeof i=="boolean"?{enabled:i,maxEntitySize:1e4,maxExpansionDepth:10,maxTotalExpansions:1e3,maxExpandedLength:1e5,allowedTags:null,tagFilter:null}:typeof i=="object"&&i!==null?{enabled:i.enabled!==!1,maxEntitySize:i.maxEntitySize??1e4,maxExpansionDepth:i.maxExpansionDepth??10,maxTotalExpansions:i.maxTotalExpansions??1e3,maxExpandedLength:i.maxExpandedLength??1e5,allowedTags:i.allowedTags??null,tagFilter:i.tagFilter??null}:k(!0)}const et=function(i){const t=Object.assign({},tt,i);return t.processEntities=k(t.processEntities),t};let I;typeof Symbol!="function"?I="@@xmlMetadata":I=Symbol("XML Node Metadata");class m{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,e){t==="__proto__"&&(t="#__proto__"),this.child.push({[t]:e})}addChild(t,e){t.tagname==="__proto__"&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child}),e!==void 0&&(this.child[this.child.length-1][I]={startIndex:e})}static getMetaDataSymbol(){return I}}class it{constructor(t){this.suppressValidationErr=!t,this.options=t}readDocType(t,e){const r={};if(t[e+3]==="O"&&t[e+4]==="C"&&t[e+5]==="T"&&t[e+6]==="Y"&&t[e+7]==="P"&&t[e+8]==="E"){e=e+9;let o=1,s=!1,a=!1,l="";for(;e<t.length;e++)if(t[e]==="<"&&!a){if(s&&E(t,"!ENTITY",e)){e+=7;let n,d;if([n,d,e]=this.readEntityExp(t,e+1,this.suppressValidationErr),d.indexOf("&")===-1){const u=n.replace(/[.\-+*:]/g,"\\.");r[n]={regx:RegExp(`&${u};`,"g"),val:d}}}else if(s&&E(t,"!ELEMENT",e)){e+=8;const{index:n}=this.readElementExp(t,e+1);e=n}else if(s&&E(t,"!ATTLIST",e))e+=8;else if(s&&E(t,"!NOTATION",e)){e+=9;const{index:n}=this.readNotationExp(t,e+1,this.suppressValidationErr);e=n}else if(E(t,"!--",e))a=!0;else throw new Error("Invalid DOCTYPE");o++,l=""}else if(t[e]===">"){if(a?t[e-1]==="-"&&t[e-2]==="-"&&(a=!1,o--):o--,o===0)break}else t[e]==="["?s=!0:l+=t[e];if(o!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:r,i:e}}readEntityExp(t,e){e=c(t,e);let r="";for(;e<t.length&&!/\s/.test(t[e])&&t[e]!=='"'&&t[e]!=="'";)r+=t[e],e++;if(w(r),e=c(t,e),!this.suppressValidationErr){if(t.substring(e,e+6).toUpperCase()==="SYSTEM")throw new Error("External entities are not supported");if(t[e]==="%")throw new Error("Parameter entities are not supported")}let o="";if([e,o]=this.readIdentifierVal(t,e,"entity"),this.options.enabled!==!1&&this.options.maxEntitySize&&o.length>this.options.maxEntitySize)throw new Error(`Entity "${r}" size (${o.length}) exceeds maximum allowed size (${this.options.maxEntitySize})`);return e--,[r,o,e]}readNotationExp(t,e){e=c(t,e);let r="";for(;e<t.length&&!/\s/.test(t[e]);)r+=t[e],e++;!this.suppressValidationErr&&w(r),e=c(t,e);const o=t.substring(e,e+6).toUpperCase();if(!this.suppressValidationErr&&o!=="SYSTEM"&&o!=="PUBLIC")throw new Error(`Expected SYSTEM or PUBLIC, found "${o}"`);e+=o.length,e=c(t,e);let s=null,a=null;if(o==="PUBLIC")[e,s]=this.readIdentifierVal(t,e,"publicIdentifier"),e=c(t,e),(t[e]==='"'||t[e]==="'")&&([e,a]=this.readIdentifierVal(t,e,"systemIdentifier"));else if(o==="SYSTEM"&&([e,a]=this.readIdentifierVal(t,e,"systemIdentifier"),!this.suppressValidationErr&&!a))throw new Error("Missing mandatory system identifier for SYSTEM notation");return{notationName:r,publicIdentifier:s,systemIdentifier:a,index:--e}}readIdentifierVal(t,e,r){let o="";const s=t[e];if(s!=='"'&&s!=="'")throw new Error(`Expected quoted string, found "${s}"`);for(e++;e<t.length&&t[e]!==s;)o+=t[e],e++;if(t[e]!==s)throw new Error(`Unterminated ${r} value`);return e++,[e,o]}readElementExp(t,e){e=c(t,e);let r="";for(;e<t.length&&!/\s/.test(t[e]);)r+=t[e],e++;if(!this.suppressValidationErr&&!v(r))throw new Error(`Invalid element name: "${r}"`);e=c(t,e);let o="";if(t[e]==="E"&&E(t,"MPTY",e))e+=4;else if(t[e]==="A"&&E(t,"NY",e))e+=2;else if(t[e]==="("){for(e++;e<t.length&&t[e]!==")";)o+=t[e],e++;if(t[e]!==")")throw new Error("Unterminated content model")}else if(!this.suppressValidationErr)throw new Error(`Invalid Element Expression, found "${t[e]}"`);return{elementName:r,contentModel:o.trim(),index:e}}readAttlistExp(t,e){e=c(t,e);let r="";for(;e<t.length&&!/\s/.test(t[e]);)r+=t[e],e++;w(r),e=c(t,e);let o="";for(;e<t.length&&!/\s/.test(t[e]);)o+=t[e],e++;if(!w(o))throw new Error(`Invalid attribute name: "${o}"`);e=c(t,e);let s="";if(t.substring(e,e+8).toUpperCase()==="NOTATION"){if(s="NOTATION",e+=8,e=c(t,e),t[e]!=="(")throw new Error(`Expected '(', found "${t[e]}"`);e++;let l=[];for(;e<t.length&&t[e]!==")";){let n="";for(;e<t.length&&t[e]!=="|"&&t[e]!==")";)n+=t[e],e++;if(n=n.trim(),!w(n))throw new Error(`Invalid notation name: "${n}"`);l.push(n),t[e]==="|"&&(e++,e=c(t,e))}if(t[e]!==")")throw new Error("Unterminated list of notations");e++,s+=" ("+l.join("|")+")"}else{for(;e<t.length&&!/\s/.test(t[e]);)s+=t[e],e++;const l=["CDATA","ID","IDREF","IDREFS","ENTITY","ENTITIES","NMTOKEN","NMTOKENS"];if(!this.suppressValidationErr&&!l.includes(s.toUpperCase()))throw new Error(`Invalid attribute type: "${s}"`)}e=c(t,e);let a="";return t.substring(e,e+8).toUpperCase()==="#REQUIRED"?(a="#REQUIRED",e+=8):t.substring(e,e+7).toUpperCase()==="#IMPLIED"?(a="#IMPLIED",e+=7):[e,a]=this.readIdentifierVal(t,e,"ATTLIST"),{elementName:r,attributeName:o,attributeType:s,defaultValue:a,index:e}}}const c=(i,t)=>{for(;t<i.length&&/\s/.test(i[t]);)t++;return t};function E(i,t,e){for(let r=0;r<t.length;r++)if(t[r]!==i[e+r+1])return!1;return!0}function w(i){if(v(i))return i;throw new Error(`Invalid entity name ${i}`)}const st=/^[-+]?0x[a-fA-F0-9]+$/,rt=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,ot={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function nt(i,t={}){if(t=Object.assign({},ot,t),!i||typeof i!="string")return i;let e=i.trim();if(t.skipLike!==void 0&&t.skipLike.test(e))return i;if(i==="0")return 0;if(t.hex&&st.test(e))return dt(e,16);if(e.includes("e")||e.includes("E"))return lt(i,e,t);{const r=rt.exec(e);if(r){const o=r[1]||"",s=r[2];let a=ut(r[3]);const l=o?i[s.length+1]===".":i[s.length]===".";if(!t.leadingZeros&&(s.length>1||s.length===1&&!l))return i;{const n=Number(e),d=String(n);if(n===0)return n;if(d.search(/[eE]/)!==-1)return t.eNotation?n:i;if(e.indexOf(".")!==-1)return d==="0"||d===a||d===`${o}${a}`?n:i;let u=s?a:e;return s?u===d||o+u===d?n:i:u===d||u===o+d?n:i}}else return i}}const at=/^([-+])?(0*)(\d*(\.\d*)?[eE][-\+]?\d+)$/;function lt(i,t,e){if(!e.eNotation)return i;const r=t.match(at);if(r){let o=r[1]||"";const s=r[3].indexOf("e")===-1?"E":"e",a=r[2],l=o?i[a.length+1]===s:i[a.length]===s;return a.length>1&&l?i:a.length===1&&(r[3].startsWith(`.${s}`)||r[3][0]===s)?Number(t):e.leadingZeros&&!l?(t=(r[1]||"")+r[3],Number(t)):i}else return i}function ut(i){return i&&i.indexOf(".")!==-1&&(i=i.replace(/0+$/,""),i==="."?i="0":i[0]==="."?i="0"+i:i[i.length-1]==="."&&(i=i.substring(0,i.length-1))),i}function dt(i,t){if(parseInt)return parseInt(i,t);if(Number.parseInt)return Number.parseInt(i,t);if(window&&window.parseInt)return window.parseInt(i,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}function ht(i){return typeof i=="function"?i:Array.isArray(i)?t=>{for(const e of i)if(typeof e=="string"&&t===e||e instanceof RegExp&&e.test(t))return!0}:()=>!1}class ft{constructor(t){if(this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"\xA2"},pound:{regex:/&(pound|#163);/g,val:"\xA3"},yen:{regex:/&(yen|#165);/g,val:"\xA5"},euro:{regex:/&(euro|#8364);/g,val:"\u20AC"},copyright:{regex:/&(copy|#169);/g,val:"\xA9"},reg:{regex:/&(reg|#174);/g,val:"\xAE"},inr:{regex:/&(inr|#8377);/g,val:"\u20B9"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,r)=>L(r,10,"&#")},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,r)=>L(r,16,"&#x")}},this.addExternalEntities=gt,this.parseXml=Et,this.parseTextData=pt,this.resolveNameSpace=ct,this.buildAttributesMap=mt,this.isItStopNode=wt,this.replaceEntitiesValue=Nt,this.readStopNodeData=It,this.saveTextToParentTag=Tt,this.addChild=bt,this.ignoreAttributesFn=ht(this.options.ignoreAttributes),this.entityExpansionCount=0,this.currentExpandedLength=0,this.options.stopNodes&&this.options.stopNodes.length>0){this.stopNodesExact=new Set,this.stopNodesWildcard=new Set;for(let e=0;e<this.options.stopNodes.length;e++){const r=this.options.stopNodes[e];typeof r=="string"&&(r.startsWith("*.")?this.stopNodesWildcard.add(r.substring(2)):this.stopNodesExact.add(r))}}}}function gt(i){const t=Object.keys(i);for(let e=0;e<t.length;e++){const r=t[e],o=r.replace(/[.\-+*:]/g,"\\.");this.lastEntities[r]={regex:new RegExp("&"+o+";","g"),val:i[r]}}}function pt(i,t,e,r,o,s,a){if(i!==void 0&&(this.options.trimValues&&!r&&(i=i.trim()),i.length>0)){a||(i=this.replaceEntitiesValue(i,t,e));const l=this.options.tagValueProcessor(t,i,e,o,s);return l==null?i:typeof l!=typeof i||l!==i?l:this.options.trimValues?A(i,this.options.parseTagValue,this.options.numberParseOptions):i.trim()===i?A(i,this.options.parseTagValue,this.options.numberParseOptions):i}}function ct(i){if(this.options.removeNSPrefix){const t=i.split(":"),e=i.charAt(0)==="/"?"/":"";if(t[0]==="xmlns")return"";t.length===2&&(i=e+t[1])}return i}const xt=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function mt(i,t,e){if(this.options.ignoreAttributes!==!0&&typeof i=="string"){const r=F(i,xt),o=r.length,s={};for(let a=0;a<o;a++){const l=this.resolveNameSpace(r[a][1]);if(this.ignoreAttributesFn(l,t))continue;let n=r[a][4],d=this.options.attributeNamePrefix+l;if(l.length)if(this.options.transformAttributeName&&(d=this.options.transformAttributeName(d)),d==="__proto__"&&(d="#__proto__"),n!==void 0){this.options.trimValues&&(n=n.trim()),n=this.replaceEntitiesValue(n,e,t);const u=this.options.attributeValueProcessor(l,n,t);u==null?s[d]=n:typeof u!=typeof n||u!==n?s[d]=u:s[d]=A(n,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(s[d]=!0)}if(!Object.keys(s).length)return;if(this.options.attributesGroupName){const a={};return a[this.options.attributesGroupName]=s,a}return s}}const Et=function(i){i=i.replace(/\r\n?/g,`
`);const t=new m("!xml");let e=t,r="",o="";this.entityExpansionCount=0,this.currentExpandedLength=0;const s=new it(this.options.processEntities);for(let a=0;a<i.length;a++)if(i[a]==="<")if(i[a+1]==="/"){const l=b(i,">",a,"Closing Tag is not closed.");let n=i.substring(a+2,l).trim();if(this.options.removeNSPrefix){const h=n.indexOf(":");h!==-1&&(n=n.substr(h+1))}this.options.transformTagName&&(n=this.options.transformTagName(n)),e&&(r=this.saveTextToParentTag(r,e,o));const d=o.substring(o.lastIndexOf(".")+1);if(n&&this.options.unpairedTags.indexOf(n)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${n}>`);let u=0;d&&this.options.unpairedTags.indexOf(d)!==-1?(u=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):u=o.lastIndexOf("."),o=o.substring(0,u),e=this.tagsNodeStack.pop(),r="",a=l}else if(i[a+1]==="?"){let l=S(i,a,!1,"?>");if(!l)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,e,o),!(this.options.ignoreDeclaration&&l.tagName==="?xml"||this.options.ignorePiTags)){const n=new m(l.tagName);n.add(this.options.textNodeName,""),l.tagName!==l.tagExp&&l.attrExpPresent&&(n[":@"]=this.buildAttributesMap(l.tagExp,o,l.tagName)),this.addChild(e,n,o,a)}a=l.closeIndex+1}else if(i.substr(a+1,3)==="!--"){const l=b(i,"-->",a+4,"Comment is not closed.");if(this.options.commentPropName){const n=i.substring(a+4,l-2);r=this.saveTextToParentTag(r,e,o),e.add(this.options.commentPropName,[{[this.options.textNodeName]:n}])}a=l}else if(i.substr(a+1,2)==="!D"){const l=s.readDocType(i,a);this.docTypeEntities=l.entities,a=l.i}else if(i.substr(a+1,2)==="!["){const l=b(i,"]]>",a,"CDATA is not closed.")-2,n=i.substring(a+9,l);r=this.saveTextToParentTag(r,e,o);let d=this.parseTextData(n,e.tagname,o,!0,!1,!0,!0);d==null&&(d=""),this.options.cdataPropName?e.add(this.options.cdataPropName,[{[this.options.textNodeName]:n}]):e.add(this.options.textNodeName,d),a=l+2}else{let l=S(i,a,this.options.removeNSPrefix),n=l.tagName;const d=l.rawTagName;let u=l.tagExp,h=l.attrExpPresent,x=l.closeIndex;if(this.options.transformTagName){const g=this.options.transformTagName(n);u===n&&(u=g),n=g}e&&r&&e.tagname!=="!xml"&&(r=this.saveTextToParentTag(r,e,o,!1));const C=e;C&&this.options.unpairedTags.indexOf(C.tagname)!==-1&&(e=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),n!==t.tagname&&(o+=o?"."+n:n);const y=a;if(this.isItStopNode(this.stopNodesExact,this.stopNodesWildcard,o,n)){let g="";if(u.length>0&&u.lastIndexOf("/")===u.length-1)n[n.length-1]==="/"?(n=n.substr(0,n.length-1),o=o.substr(0,o.length-1),u=n):u=u.substr(0,u.length-1),a=l.closeIndex;else if(this.options.unpairedTags.indexOf(n)!==-1)a=l.closeIndex;else{const O=this.readStopNodeData(i,d,x+1);if(!O)throw new Error(`Unexpected end of ${d}`);a=O.i,g=O.tagContent}const N=new m(n);n!==u&&h&&(N[":@"]=this.buildAttributesMap(u,o,n)),g&&(g=this.parseTextData(g,n,o,!0,h,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),N.add(this.options.textNodeName,g),this.addChild(e,N,o,y)}else{if(u.length>0&&u.lastIndexOf("/")===u.length-1){if(n[n.length-1]==="/"?(n=n.substr(0,n.length-1),o=o.substr(0,o.length-1),u=n):u=u.substr(0,u.length-1),this.options.transformTagName){const N=this.options.transformTagName(n);u===n&&(u=N),n=N}const g=new m(n);n!==u&&h&&(g[":@"]=this.buildAttributesMap(u,o,n)),this.addChild(e,g,o,y),o=o.substr(0,o.lastIndexOf("."))}else{const g=new m(n);this.tagsNodeStack.push(e),n!==u&&h&&(g[":@"]=this.buildAttributesMap(u,o,n)),this.addChild(e,g,o,y),e=g}r="",a=x}}else r+=i[a];return t.child};function bt(i,t,e,r){this.options.captureMetaData||(r=void 0);const o=this.options.updateTag(t.tagname,e,t[":@"]);o===!1||(typeof o=="string"&&(t.tagname=o),i.addChild(t,r))}const Nt=function(i,t,e){if(i.indexOf("&")===-1)return i;const r=this.options.processEntities;if(!r.enabled||r.allowedTags&&!r.allowedTags.includes(t)||r.tagFilter&&!r.tagFilter(t,e))return i;for(let o in this.docTypeEntities){const s=this.docTypeEntities[o],a=i.match(s.regx);if(a){if(this.entityExpansionCount+=a.length,r.maxTotalExpansions&&this.entityExpansionCount>r.maxTotalExpansions)throw new Error(`Entity expansion limit exceeded: ${this.entityExpansionCount} > ${r.maxTotalExpansions}`);const l=i.length;if(i=i.replace(s.regx,s.val),r.maxExpandedLength&&(this.currentExpandedLength+=i.length-l,this.currentExpandedLength>r.maxExpandedLength))throw new Error(`Total expanded content size exceeded: ${this.currentExpandedLength} > ${r.maxExpandedLength}`)}}if(i.indexOf("&")===-1)return i;for(let o in this.lastEntities){const s=this.lastEntities[o];i=i.replace(s.regex,s.val)}if(i.indexOf("&")===-1)return i;if(this.options.htmlEntities)for(let o in this.htmlEntities){const s=this.htmlEntities[o];i=i.replace(s.regex,s.val)}return i=i.replace(this.ampEntity.regex,this.ampEntity.val),i};function Tt(i,t,e,r){return i&&(r===void 0&&(r=t.child.length===0),i=this.parseTextData(i,t.tagname,e,!1,t[":@"]?Object.keys(t[":@"]).length!==0:!1,r),i!==void 0&&i!==""&&t.add(this.options.textNodeName,i),i=""),i}function wt(i,t,e,r){return!!(t&&t.has(r)||i&&i.has(e))}function vt(i,t,e=">"){let r,o="";for(let s=t;s<i.length;s++){let a=i[s];if(r)a===r&&(r="");else if(a==='"'||a==="'")r=a;else if(a===e[0])if(e[1]){if(i[s+1]===e[1])return{data:o,index:s}}else return{data:o,index:s};else a==="	"&&(a=" ");o+=a}}function b(i,t,e,r){const o=i.indexOf(t,e);if(o===-1)throw new Error(r);return o+t.length-1}function S(i,t,e,r=">"){const o=vt(i,t+1,r);if(!o)return;let s=o.data;const a=o.index,l=s.search(/\s/);let n=s,d=!0;l!==-1&&(n=s.substring(0,l),s=s.substring(l+1).trimStart());const u=n;if(e){const h=n.indexOf(":");h!==-1&&(n=n.substr(h+1),d=n!==o.data.substr(h+1))}return{tagName:n,tagExp:s,closeIndex:a,attrExpPresent:d,rawTagName:u}}function It(i,t,e){const r=e;let o=1;for(;e<i.length;e++)if(i[e]==="<")if(i[e+1]==="/"){const s=b(i,">",e,`${t} is not closed`);if(i.substring(e+2,s).trim()===t&&(o--,o===0))return{tagContent:i.substring(r,e),i:s};e=s}else if(i[e+1]==="?")e=b(i,"?>",e+1,"StopNode is not closed.");else if(i.substr(e+1,3)==="!--")e=b(i,"-->",e+3,"StopNode is not closed.");else if(i.substr(e+1,2)==="![")e=b(i,"]]>",e,"StopNode is not closed.")-2;else{const s=S(i,e,">");s&&((s&&s.tagName)===t&&s.tagExp[s.tagExp.length-1]!=="/"&&o++,e=s.closeIndex)}}function A(i,t,e){if(t&&typeof i=="string"){const r=i.trim();return r==="true"?!0:r==="false"?!1:nt(i,e)}else return X(i)?i:""}function L(i,t,e){const r=Number.parseInt(i,t);return r>=0&&r<=1114111?String.fromCodePoint(r):e+i+";"}const P=m.getMetaDataSymbol();function yt(i,t){return U(i,t)}function U(i,t,e){let r;const o={};for(let s=0;s<i.length;s++){const a=i[s],l=Ot(a);let n="";if(e===void 0?n=l:n=e+"."+l,l===t.textNodeName)r===void 0?r=a[l]:r+=""+a[l];else{if(l===void 0)continue;if(a[l]){let d=U(a[l],t,n);const u=At(d,t);a[P]!==void 0&&(d[P]=a[P]),a[":@"]?St(d,a[":@"],n,t):Object.keys(d).length===1&&d[t.textNodeName]!==void 0&&!t.alwaysCreateTextNode?d=d[t.textNodeName]:Object.keys(d).length===0&&(t.alwaysCreateTextNode?d[t.textNodeName]="":d=""),o[l]!==void 0&&o.hasOwnProperty(l)?(Array.isArray(o[l])||(o[l]=[o[l]]),o[l].push(d)):t.isArray(l,n,u)?o[l]=[d]:o[l]=d}}}return typeof r=="string"?r.length>0&&(o[t.textNodeName]=r):r!==void 0&&(o[t.textNodeName]=r),o}function Ot(i){const t=Object.keys(i);for(let e=0;e<t.length;e++){const r=t[e];if(r!==":@")return r}}function St(i,t,e,r){if(t){const o=Object.keys(t),s=o.length;for(let a=0;a<s;a++){const l=o[a];r.isArray(l,e+"."+l,!0,!0)?i[l]=[t[l]]:i[l]=t[l]}}}function At(i,t){const{textNodeName:e}=t,r=Object.keys(i).length;return!!(r===0||r===1&&(i[e]||typeof i[e]=="boolean"||i[e]===0))}class Pt{constructor(t){this.externalEntities={},this.options=et(t)}parse(t,e){if(typeof t!="string"&&t.toString)t=t.toString();else if(typeof t!="string")throw new Error("XML data is accepted in String or Bytes[] form.");if(e){e===!0&&(e={});const s=B(t,e);if(s!==!0)throw Error(`${s.err.msg}:${s.err.line}:${s.err.col}`)}const r=new ft(this.options);r.addExternalEntities(this.externalEntities);const o=r.parseXml(t);return this.options.preserveOrder||o===void 0?o:yt(o,this.options)}addEntity(t,e){if(e.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(t.indexOf("&")!==-1||t.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(e==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=e}static getMetaDataSymbol(){return m.getMetaDataSymbol()}}export{Pt as XMLParser};
